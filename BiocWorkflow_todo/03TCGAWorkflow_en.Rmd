---
title: 'TCGA 工作流程: 利用Bioconductor包分析癌症基因组学及表观基因组学数据
'
date: "`r Sys.Date()`"
author:
- name: Tiago Chedraoui Silva
  affiliation: 
  - &id Department of Genetics, Ribeirao Preto Medical School, University of Sao Paulo, Ribeirao Preto, Brazil
  email: tiagochst@gmail.com
- name: Antonio Colaprico
  affiliation:  
  - &id2 Interuniversity Institute of Bioinformatics in Brussels , Brussels, Belgium
  - &id3 Machine Learning Group (MLG), University Libre de Bruxelles, Brussels, Belgium
  email: antonio.colaprico@gmail.com
- name: Catharina Olsen
  affiliation: 
  - *id2
  - *id3
  email: colsen@ulb.ac.be
- name: Fulvio D’Angelo
  affiliation: 
  - Institute for Cancer Genetics, Columbia University Medical Center, New York, New York 10032, USA.
  - BIOGEM Istituto di Ricerche Genetiche ‘G. Salvatore’, Campo Reale, 83031 Ariano Irpino, Italy. 
  email: fulvio.dangelo@biogem.it
- name: Gianluca Bontempi
  affiliation: *id3
  email: gbonte@ulb.ac.be
- name: Michele Ceccarelli
  affiliation: 
  - Department of Science and Technology, University of Sannio, Benevento, Italy.
  - BIOGEM Istituto di Ricerche Genetiche "G. Salvatore", Ariano Irpino, Italy.
  email: ceccarelli@unisannio.it
- name: Houtan Noushmehr
  affiliation: 
  - Department of Neurosurgery, Henry Ford Hospital, Detroit, Detroit, MI, USA
  - *id
  email: houtana@gmail.com
output: 
    BiocStyle::html_document:
        toc: true
        number_sections: false
        toc_depth: 2
        theme: flatly
        toc_float: true
        highlight: tango
        df_print: kable
        code_folding: show
bibliography: bibliography.bib

vignette: >
  %\VignetteIndexEntry{'TCGA Workflow: Analyze cancer genomics and epigenomics data using Bioconductor packages'}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

  

```{r setup, include=FALSE, echo=F, warning= F, message=F}
knitr::opts_chunk$set(message = FALSE, 
                      warning = FALSE, 
                      error = FALSE, 
                      tidy = FALSE,
                      fig.align="center", 
                      dpi = 150, 
                      cache = FALSE,
                      progress=FALSE, 
                      quite = TRUE)
```

```{r, echo=FALSE, results="hide", warning=FALSE,message=FALSE}
suppressPackageStartupMessages({
  if("TCGAWorkflow" %in% installed.packages()[,1]) {
    library(TCGAWorkflow)
  } else {
    devtools::load_all(".")
  }
})
```


# 环境

**R 版本**: `r R.version.string`

**Bioconductor 版本**: `r BiocManager::version()`

**R包**: `r packageVersion("TCGAWorkflow")`
   

# 说明

工作流程基于文章: [TCGA Workflow: Analyze cancer genomics and epigenomics data using Bioconductor packages](https://f1000research.com/articles/5-1542/v2) [@10.12688/f1000research.8923.2].
由于内存和时间限制，我们仅下载了部分数据，真实分析时请利用所有可获得的数据。示例中使用的数据在如下R包中可用 `r Biocpkg("TCGAWorkflowData")`。


## 安装

请加载如下代码确保本工作流程可正常运行：

```{R, eval=FALSE, include=TRUE}
if (!"BiocManager" %in% rownames(installed.packages()))
     install.packages("BiocManager")
BiocManager::install("TCGAWorkflow")
```

## 加载R包

每部分开始前，应确保已加载相关R包。以下R包应在全部步骤开始前加载。


- TCGAWorkflowData: 这个R包包含执行分析步骤所必需的数据。为了加快演示速度，示例仅下载该数据的子集，正式分析时应采用全部数据。


- DT: 用于结果可视化

```{R, eval=TRUE, message=FALSE, warning=FALSE, include=TRUE}
library(TCGAWorkflowData)
library(DT)
```

```{R, eval=TRUE, message=FALSE, warning=FALSE, include=FALSE}
library(TCGAbiolinks)
```

# 摘要

测序生物技术大幅进步带来了大型国际机构公共数据库爆炸式增长，例如 [癌症基因组图谱 (TCGA)](http://cancergenome.nih.gov/) 、[DNA元件百科全书 (ENCODE)](http://www.encodeproject.org/)及 [NIH表观基因组图谱绘制联盟(Roadmap)](http://www.roadmapepigenomics.org/)。这些项目提供了大量以高基因组分辨率获取已培养的肿瘤细胞系、正常组织及肿瘤组织表观基因组信息的机会。[Bioconductor](http://www.bioconductor.org/)项目提供了1,000多个开源软件和统计软件包，用于分析高通量基因组数据。然而，大多数软件包仅为特定数据类型（基因表达量、表观遗传学、基因组学）设计，目前尚无对这三个公开项目的资源、数据的进行完整综合分析的复合型工具。近来有人提出整合这些不同分析的需求。在此工作流程中我们提供了一系列针对不同分子数据的生物学重点综合分析过程，阐述TCGA数据下载、处理、准备及利用数个重要Bioconductor包获取具有生物学意义的基因组和表观基因组数据的方法。我们提出利用Roadmap和ENCODE数据，识别与癌症相关的生物学功能性表观基因组的元素的工作计划。























我们分析了两种类型脑肿瘤：低级别胶质瘤 (LGG)与高级别胶质瘤 (glioblastoma
multiform or GBM)，从而阐明我们的工作流程。 


本工作流程中所涉及所有R包均可通过[biocViews interface](http://www.bioconductor.org/packages/release/BiocViews.html#___Software)获得。

**关键词:** 表观基因组学、基因组学、肿瘤、非编码、TCGA、ENCODE、Roadmap、生物信息学。

# 引言

癌症是一种复杂的涉及多种分子过程的遗传性疾病，例如点突变、结构变异、易位及表观遗传学或转录信号/网络激活。这些过程影响不同时空范围层间通信、反馈机制，从而创建出高度复杂的动态系统。为了深入了解肿瘤生物学，癌症基因组学的大多数研究旨在整合多个分子尺度的观察结果及其相互作用的分析结果。即使多种肿瘤具有相似的复发基因组过程，目前尚未阐明其与所观察到的表型之间的关系。例如，虽然我们知道大多数最具侵袭性的脑肿瘤形式如胶质瘤均含有单个基因（IDH）的突变，但其特征性表观遗传和转录信号激活的机制仍有待进一步研究阐述。此外， 近来构建网络框架已成为发现作为癌症表型主要调节因子的功能性疾病驱动因素的有效策略。这里，我们描述了一个集成多种Bioconductor软件包，以便在大规模癌症数据集中分析和整合多个分子观察层的综合工作流程。





















实际上，最近技术发展带来了基因组和表观基因组数据， 如基因表达、DNA甲基化和转录因子基因组定位，大量沉积于可免费获取的国际机构公共数据库例如癌症基因组图谱 [(TCGA)](http://cancergenome.nih.gov/) 、DNA元件百科全书[(ENCODE)](http://www.encodeproject.org/)及NIH表观基因组图谱绘制联盟[(Roadmap)](http://www.roadmapepigenomics.org/) [@Hawkins]。三个数据库的概述如下:









-   **癌症基因组图谱 (TCGA):** TCGA项目由美国国立卫生研究院(NIH)发起, 公开获取超过30种类型人类癌症的分子和临床信息，包括外显子组 (变量分析)、单核苷酸多态性 (SNP)、 DNA甲基化,、转录组
    (mRNA), 小分子核糖核酸 (miRNA) 和蛋白组学。TCGA样本类型包括: 原发实体肿瘤、复发实体肿瘤、血液来源正常和肿瘤、远处转移及实体正常组织。
    [@weinstein2013cancer].







-   **DNA元件百科全书 (ENCODE):** 2003年由美国国家人类基因组研究所(NHGRI)成立，该项目旨在为基因组中发挥积极作用的功能元素建立综合列表，包括基因表达调控因子。 生物样品包括永生细胞系、组织、元代细胞和干细胞 [@encode2011user]。






-   **NIH表观基因组图谱绘制联盟(Roadmap):** 项目成立目的是获得人类表观遗传学数据公共资源，从而分析生物及疾病相关研究。Roadmap绘制了干细胞和primary ex vivo tissues DNA甲基化、组蛋白修饰、 chromatin accessibility和小RNA转录本的图景[@Fingerman; @Bernstein]。






简而言之，这三个项目为各种芯片和新一代测序（NGS）平台提供了大规模的表观基因组数据。每一个都包含特定类型的组织或细胞的特定类型的生物信息，并且当综合分析时，它为研究实验室提供了在分子水平上更好地了解正常细胞向癌症状态的发展进程，尤其是表型与起源组织之间联系的宝贵机会。








尽管存在多种获取癌症相关数据的方式[@kannan2015public]，但在统计分析大规模基因组数据方面，[Bioconductor](http://www.bioconductor.org/)可以作为全面开源、更新及集成专业工具集的代表之一。因此，我们以Bioconductor为基础，提出了我们的工作流程，来描述如何下载、处理、分析和整合癌症数据，以了解特定癌症相关的具体问题。然而，在基因调控网络的背景下，目前尚无工具可以解决整体序列与突变信息、表观基因组状态及基因表达之间的整合，从而识别肿瘤进展中致癌因素及改变表征的通路的问题。总而言之，我们的工作流程呈现了使用数个 [Bioconductor](http://www.bioconductor.org/) 包处理基因组和表观基因组学数据的过程。















# 方法
## 获取数据

TCGA 数据可以通过以下途径获取：the NCI Genomic Data Commons (GDC) [data
portal](https://gdc-portal.nci.nih.gov/), [GDC Legacy
Archive](https://gdc-portal.nci.nih.gov/legacy-archive/search/f) 和
[Broad Institute’s GDAC Firehose](gdac.broadinstitute.org). The GDC Data
Portal提供了TCGA数据库中所有癌种数据的获取途径，全部数据使用GRCh38(hg38)基因组作为参考基因组，
统一使用GDC Bioinformatics Pipelines流程进行处理，该流程提供了生物样本及临床数据的标准化方法， 
DNA和RNA测序数据基于GRCh38重比对的方法和相关衍生数据产出的方法。然而，the GDC Legacy 
Archive提供了之前存储于[CGHub](https://cghub.ucsc.edu/)[@wilks2014cancer]和由the TCGA Data 
Coordinating Center (DCC)主管的TCGA Data 
Portal的备份数据的获取途径，这些数据均未经修改，使用GRCh37(hg19)和GRCh36(hg18)基因组作为参考基
因组。




存储在CGHub, TCGA Data Portal和Broad Institute下属的GDAC
Firehose数据按照不同的处理等级（原始数据，标准化数据，整合后数据）与获取等级（管制，公开）组合
被划分为不同的层级。Level 1表明该数据为受管制的原始数据，Level 
2表明该数据为受管制的已处理数据，Level 
3表明该数据为分段数据或解释型数据，该等级数据已经被公开，Level 
4表明该数据为公开的感兴趣区域数据。TCGA Data 
Portal提供1-3等级数据，Firehose则只提供3-4等级的数据。对于不同等级的解释说明可以参考TCGA 
Wiki百科[TCGA Wiki](https://wiki.nci.nih.gov/display/TCGA/Data+level)。然而，GDC Data 
Portal已经不再使用该等级分类方法。GDC Data Portal重新制定了新的等级划分规则，详情见[GDC
documentation](https://gdc.nci.nih.gov/developers/gdc-data-model/gdc-data-model-components)。
在新的规则中，数据被划分为开放获取类型与受控获取类型。虽然在GDC Data 
Portal中，访问开放获取类型数据不需要身份验证或授权，这些数据通常包括不能单独识别的高级基因组数
据以及大部分临床数据和所有样本数据元素，但受控获取类型的数据需要dbGaP授权和eRACommons认证，这些
数据通常包括个体可识别的数据，如低水平基因组测序数据、种系变异、SNP6基因型数据和某些临床数据。
获取受控获取类型数据的过程详见GDC网站[GDC web 
site](https://gdc.nci.nih.gov/access-data/obtaining-access-controlled-data)











最后，由[GDC data portal](https://gdc-portal.nci.nih.gov/)和[GDC Legacy
Archive](https://gdc-portal.nci.nih.gov/legacy-archive/search/f)提供的数据可以通过Bioconductor
平台的 can be [TCGAbiolinks](http://bioconductor.org/packages/TCGAbiolinks/)获取, 
而由Firehose提供的数据则可以通过Bioconductor平台的[RTCGAToolbox](http://bioconductor.org/packag
es/RTCGAToolbox/)获得。



接来来的部分将会讲述如何使用[TCGAbiolinks](http://bioconductor.org/packages/TCGAbiolinks/)和
[RTCGAToolbox](http://bioconductor.org/packages/RTCGAToolbox/)来下载临床数据，基因组数据，转录
组数据，表观基因组数据以及亚型信息和阵列信息（GISTIC）（例如通过可推动肿瘤生长的体细胞拷贝数变
化（SCNAs）鉴定出的目标基因）。在该工作流程中，所有的数据均使用hg19作为参考基因组。





### 从TCGA Data Portal下载数据

Bioconductor平台的 [TCGAbiolinks](http://bioconductor.org/packages/TCGAbiolinks/)[@TCGAbiolinks
] 主要通过三个函数实现数据下载，分别是*GDCquery*, 
*GDCdownload*和*GDCprepare*。我们可以依次使用这三个函数分别进行数据搜索，数据下载与数据加载为R
对象的工作。


*GDCquery*函数使用[GDC API](https://gdc.cancer.gov/developers/gdc-application-programming-inter
face-api)对已有的项目和数据类别进行搜索，按照样品，样品类型，文件类型以及其他用户需要的特征进行
筛选。该函数会返回一个汇总表格对象，其中包含经搜索后符合筛选参数的所有信息，如样本，文件和其他
有用信息。*GDCquery*函数最重要的参数是*project*，该参数会接收到GDC的项目信息，如TCGA-USC, 
TCGA-LGG, TARGET-AML等，*data.category* 参数用于接收数据分类，如转录组数据（Transcriptome 
Profiling）, 拷贝数变异（Copy Number Variation）, DNA甲基化（DNA methylation）, 
基因表达谱（Gene expression）等，*data.type*用于接收数据类型，如基因表达定量（Gene expression 
quantification）, 异构体表达定量（Isoform Expression Quantification）,miRNA表达定量（miRNA 
Expression Quantification），拷贝数段（Copy Number Segment），屏蔽拷贝数段（Masked Copy Number 
Segment）等，*workflow.type*用于接收GDC工作流程种类，包括HTSeq - Counts，HTSeq - FPKM-UQ和HTSeq - FPKM。*legacy*用于选择使用先前的数据库或者使用经统一的数据库。*file.type*用于接收文件类型，从
而在先前的数据库中进行搜索，该参数包括hg18.seg，hg19.seg，nocnv\_，hg18.seg， 
nocnv\_hg19.seg，rsem.genes.results，rsem.genes.normalized\_results等。*platform*参数用于接收平
台信息从而进行搜索，包括HumanMethylation27, Genome\_Wide\_SNP\_6, 
IlluminaHiSeq\_RNASeqV2等。所有可以使用的参数信息列表详见[TCGAbiolinks vignette](https://www.bioconductor.org/packages/3.3/bioc/vignettes/TCGAbiolinks/inst/doc/tcgaBi
olinks.html#harmonized-data-1)。









列表1为该函数的举例。

完成搜索步骤后，用户可以使用*GDCdownload*函数将所得数据进行下载，该函数通过两个途径对数据进行下
载，一个是通过GDC API，另一个则是通过[gdc client 
tools](https://gdc.cancer.gov/access-data/gdc-data-transfer-tool)进行下载。数据将会被下载并保存
到项目名称的目录下，同时会生一个由数据分类命名的子文件夹，例如"TCGA-GBM/DNA\_methylation"。




最后，*GDCprepare*可以把下载的数据转换成[summarizedExperiment](http
://bioconductor.org/packages/SummarizedExperiment/)[@huber2015orche
strating]对象或数据框。如果*SummarizedExperiment*被设置为TRUE， 
TCGAbiolinks将会添加亚型信息临床信息，该信息由The Cancer Genome
Atlas (TCGA) Research Network报告提供，详情可见[TCGAquery\_subtype 
section](http://bioconductor.org/packages/devel/bioc/vignettes/TCGA
biolinks/inst/doc/tcgaBiolinks.html#tcgaquery_subtype-working-with-
molecular-subtypes-data.)。表1对于如何使用这些函数从GDC先前的数据库
下载DNA甲基化和基因表达数据进行了说明，表2展示了如何从已统一后的数
据库中下载拷贝数突变数据。其他可以从统一后数据库中下载数据的例子详
见[TCGAbiolinks vignette](https://www.bioconductor.org/packages/3.3
/bioc/vignettes/TCGAbiolinks/inst/doc/tcgaBiolinks.html)。





```{R, eval=FALSE, include=TRUE}
library(TCGAbiolinks)
# 提示：legacy数据库中的数据使用hg19作为参考基因组
query.met.gbm <- GDCquery(project = "TCGA-GBM", 
                          legacy = TRUE,
                          data.category = "DNA methylation",
                          platform = "Illumina Human Methylation 450", 
                          barcode = c("TCGA-76-4926-01B-01D-1481-05", "TCGA-28-5211-01C-11D-1844-05"))
GDCdownload(query.met.gbm)

met.gbm.450 <- GDCprepare(query = query.met.gbm,
                          save = TRUE, 
                          save.filename = "gbmDNAmet450k.rda",
                          summarizedExperiment = TRUE)

query.met.lgg <- GDCquery(project = "TCGA-LGG", 
                          legacy = TRUE,
                          data.category = "DNA methylation",
                          platform = "Illumina Human Methylation 450",
                          barcode = c("TCGA-HT-7879-01A-11D-2399-05", "TCGA-HT-8113-01A-11D-2399-05"))
GDCdownload(query.met.lgg)
met.lgg.450 <- GDCprepare(query = query.met.lgg,
                          save = TRUE, 
                          save.filename = "lggDNAmet450k.rda",
                          summarizedExperiment = TRUE)
met.gbm.lgg <- SummarizedExperiment::cbind(met.lgg.450, met.gbm.450)


query.exp.lgg <- GDCquery(project = "TCGA-LGG", 
                          legacy = TRUE,
                          data.category = "Gene expression",
                          data.type = "Gene expression quantification",
                          platform = "Illumina HiSeq", 
                          file.type = "results",
                          sample.type = "Primary solid Tumor")
GDCdownload(query.exp.lgg)
exp.lgg <- GDCprepare(query = query.exp.lgg, save = TRUE, save.filename = "lggExp.rda")

query.exp.gbm <- GDCquery(project = "TCGA-GBM", 
                          legacy = TRUE,
                          data.category = "Gene expression",
                          data.type = "Gene expression quantification",
                          platform = "Illumina HiSeq", 
                          file.type = "results",
                          sample.type = "Primary solid Tumor")
GDCdownload(query.exp.gbm)
exp.gbm <- GDCprepare(query = query.exp.gbm, save = TRUE, save.filename = "gbmExp.rda")
exp.gbm.lgg <- SummarizedExperiment::cbind(exp.lgg, exp.gbm)
```

```{R, eval=FALSE, include=TRUE}
#-----------------------------------------------------------------------------
#                   Data.category: Copy number variation aligned to hg38
#-----------------------------------------------------------------------------
query <- GDCquery(project = "TCGA-ACC",
                  data.category = "Copy Number Variation",
                  data.type = "Copy Number Segment",
                  barcode = c( "TCGA-OR-A5KU-01A-11D-A29H-01", "TCGA-OR-A5JK-01A-11D-A29H-01"))
GDCdownload(query)
data <- GDCprepare(query)

query <- GDCquery("TCGA-ACC",
                  "Copy Number Variation",
                  data.type = "Masked Copy Number Segment",
                  sample.type = c("Primary solid Tumor")) # see the barcodes with getResults(query)$cases
GDCdownload(query)
data <- GDCprepare(query)
```
如果[SummarizedExperiment 
object](http://www.nature.com/nmeth/journal/v12/n2/fig_tab/nmeth.3252_F2.html)被选择，数据可
以通过三种不同的访问形式被获取：*assay*用于数据信息，*rowRanges*用于得到每行数值的取值范围，
*colData*用于得到样本信息，例如病人编号，批次，样本类型等 [@huber2015orchestrating; 
@SummarizedExperiment]。下面将会举例展示。



```{R, eval=TRUE, include=TRUE}
library(SummarizedExperiment)

# Load object from TCGAWorkflowData package
# THis object will be created in the further sections,
data(GBMIllumina_HiSeq) 

# get expression matrix
data <- assay(gbm.exp)
datatable(data[1:10,], 
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)

# get genes information
genes.info <- rowRanges(gbm.exp)
genes.info

# get sample information
sample.info <- colData(gbm.exp)
datatable(as.data.frame(sample.info), 
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = FALSE)

```

在TCGAbiolinks中，可以通过两种方式获取临床数据。第一种方法为只下载有索引的GDC临床数据，该数
据包含诊断记录信息（生理特征，至死亡的天数，接收诊断时的年龄，至最后一次随访的天数，至复发的
天数），临床治疗信息（接受治疗天数，治疗id，治疗机构，治疗目的的种类），人口统计信息（性别，
人种，种族）和展露度信息（每日吸烟颗数，体重，身高，饮酒史）。临床索引信息数据可以使用*GDCqu
ery\_clinical*函数获取。该函数有两个参数，*project* （"TCGA-GBM","TARGET-AML"等）和 *type* 
（临床或样本）。 第二种方法则需要下载XML文件，该文件包含记录病人的临床数据，随后在该文件中检
索得到需要的信息。通过这种方式我们可以得到所有可获得的临床数据，包括病人信息（肿瘤组织位点，
组织类型，性别，生理特征，出生日期，至最后一次随访天数等），用药信息（至药物治疗开始日期，至
药物治疗结束日期，治疗类型，药物名称），放射治疗记录（至放射治疗起始天数，至放射治疗终止天数
，放射类型，放射剂量），新肿瘤出现记录（在第一阶段治疗后长出新肿瘤的天数，新肿瘤赘生物类型，
额外的药物治疗），跟进随访记录（初期治疗结果成功与否，跟进治疗成功与否，生理特征，至最后一次
随访天数，记录完成日期），阶段事件记录（病理学阶段），管理记录（批次，项目代码，疾病代码，Bi
ospecimen Core Resource）。












```{R, eval=TRUE, include=TRUE}
# get indexed clinical patient data for GBM samples
gbm_clin <- GDCquery_clinic(project = "TCGA-GBM", type = "Clinical")

# get indexed clinical patient data for LGG samples
lgg_clin <- GDCquery_clinic(project = "TCGA-LGG", type = "Clinical")

# Bind the results, as the columns might not be the same,
# we will will plyr rbind.fill, to have all columns from both files
clinical <- plyr::rbind.fill(gbm_clin,lgg_clin)
```
```{r  echo = TRUE, message = FALSE, warning = FALSE}
datatable(clinical[1:10,], options = list(scrollX = TRUE, keys = TRUE), rownames = FALSE)
```


```{r results = 'hide', echo=TRUE, message=FALSE, warning=FALSE}
# Fetch clinical data directly from the clinical XML files.
# if barcode is not set, it will consider all samples.
# We only set it to make the example faster
query <- GDCquery(project = "TCGA-GBM",
                  file.type = "xml",
                  data.category = "Clinical",
                  barcode = c("TCGA-08-0516","TCGA-02-0317")) 
GDCdownload(query)
clinical <- GDCprepare_clinic(query, clinical.info = "patient")
```
```{r  echo = TRUE, message = FALSE, warning = FALSE}
datatable(clinical, options = list(scrollX = TRUE, keys = TRUE), rownames = FALSE)
```
```{r results = 'hide', echo=TRUE, message=FALSE, warning=FALSE}
clinical.drug <- GDCprepare_clinic(query, clinical.info = "drug")
```
```{r  echo = TRUE, message = FALSE, warning = FALSE}
datatable(clinical.drug, options = list(scrollX = TRUE, keys = TRUE), rownames = FALSE)
```
```{r results = 'hide', echo=TRUE, message=FALSE, warning=FALSE}
clinical.radiation <- GDCprepare_clinic(query, clinical.info = "radiation")
```
```{r  echo = TRUE, message = FALSE, warning = FALSE}
datatable(clinical.radiation, options = list(scrollX = TRUE,  keys = TRUE), rownames = FALSE)
```
```{r results = 'hide', echo=TRUE, message=FALSE, warning=FALSE}
clinical.admin <- GDCprepare_clinic(query, clinical.info = "admin")
```
```{r  echo = TRUE, message = FALSE, warning = FALSE}
datatable(clinical.admin, options = list(scrollX = TRUE, keys = TRUE), rownames = FALSE)
```

变异信息被储存在两种编译注释文件中：Protected MAF文件和Somatic 
MAF文件，以上两种文件均来源于GDC中经注释的VCF文件。经注释的VCF文件经常出现多个转录本的突变体
报告，而Protected MAF(\*protected.maf)则仅提供最为重要的突变体报告，Somatic 
MAF文件(\*somatic.maf)对于数据进行了更进一步地处理，移除了低质量的突变体信息和潜在的生殖系变
异。使用[TCGAbiolinks](http://bioconductor.org/packages/TCGAbiolinks/)中的*GDCquery\_maf*函
数可以下载Somatic MAF数据，下面将举例说明。




```{R, eval=FALSE, include=TRUE}
LGGmut <- GDCquery_Maf(tumor = "LGG", pipelines = "mutect2")
```

```{r  echo = TRUE, message = FALSE, warning = FALSE}
data(mafMutect2LGGGBM)
datatable(LGGmut[1:10,], options = list(scrollX = TRUE, keys = TRUE), rownames = FALSE)
```

最后，Cancer Genome Atlas (TCGA) Research 
Network已经报道了多种疾病的完整的全基因组水平研究结果包括：ACC
[@zheng2016comprehensive], BRCA [@cancer2012comprehensive_brca], COAD
[@cancer2012comprehensive_colon], GBM [@Cell], HNSC
[@cancer2015comprehensive], KICH [@davis2014somatic], KIRC
[@cancer2013comprehensive], KIRP [@cancer2016comprehensive], LGG
[@Cell], LUAD [@cancer2014comprehensive_lung], LUSC
[@cancer2012comprehensive_lusc], PRAD [@cancer2015molecular_prad], READ
[@cancer2012comprehensive_colon], SKCM [@cancer2015genomic_skcm], STAD
[@cancer2014comprehensive_stad], THCA [@cancer2014integrated_thca] and
UCEC [@cancer2014comprehensive_gastric]。 
以上分类可以通过*TCGAquery\_subtype*函数进行检索，或者通过样本信息获取，样本信息来自于由*GDC
prepare*函数创建的SummarizedExperiment对象。



```{R, eval=TRUE, include=TRUE}
gbm.subtypes <- TCGAquery_subtype(tumor = "gbm")
```

```{r  echo = TRUE, message = FALSE, warning = FALSE}
datatable(gbm.subtypes[1:10,], options = list(scrollX = TRUE, keys = TRUE), rownames = FALSE)
```


### 从Broad TCGA GDAC下载数据

Bioconductor平台的[RTCGAToolbox](http://bioconductor.org/packages/RTCGAToolbox/)
[@samur2014rtcgatoolbox]通过*getFirehoseData*函数使我们可以获得Firehose中等级为3和4的数据。 
通过下面所列参数，用户可以选择数据版本以及感兴趣的癌种。
-   dataset - Tumor to download。完整的清单详见*getFirehoseDatasets*函数。

-   runDate - Stddata run dates。日期可以通过*getFirehoseRunningDates*函数查看。

-   gistic2\_Date - Analyze run dates。日期可以通过*getFirehoseAnalyzeDates*函数查看。

这些参数可用于选择数据类型进行下载，包括：
RNAseq\_Gene, Clinic, miRNASeq\_Gene, ccRNAseq2\_Gene\_Norm, CNA\_SNP,
CNV\_SNP, CNA\_Seq, CNA\_CGH, Methylation, Mutation, mRNA\_Array ,
miRNA\_Array和RPPA。

根据默认参数，
[RTCGAToolbox](http://bioconductor.org/packages/RTCGAToolbox/)允许用户下载上限为500M的数据。
如果想要增加下载数据空间上限，用户可以使用 
*fileSizeLimit*参数进行调整。下面我们将会举例说明。用户可以通过*getData*函数获取下载的数据（
详见22-24行，所得数据为S4Vector对象）。









```{R, eval=FALSE, include=TRUE}
library(RTCGAToolbox)
```

```{R, eval=FALSE, include=TRUE}
# 得到最近一次运行日期
lastRunDate <- getFirehoseRunningDates()[1]

# 得到GBM的DNA甲基化数据，RNAseq2及相应的临床数据
gbm.data <- getFirehoseData(dataset = "GBM",
                            runDate = lastRunDate, 
                            gistic2Date = getFirehoseAnalyzeDates(1),
                            Methylation = FALSE,  
                            clinical = TRUE,
                            RNASeq2GeneNorm  = FALSE, 
                            Mutation = TRUE,
                            fileSizeLimit = 10000)

gbm.mut <- getData(gbm.data,"Mutation")
gbm.clin <- getData(gbm.data,"clinical")
```

最后，[RTCGAToolbox](http://bioconductor.org/packages/RTCGAToolbox/)可以让用户得到等级为4的
数据。当用户需要使用GISTIC结果的时候，这种方法会显得非常快捷方便。GISTIC被用于鉴定通过体细胞
拷贝数突变（SCNAs）而得到的基因[@mermel2011gistic2]。


```{R, eval=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# 下载GISTIC结果
lastanalyzedate <- getFirehoseAnalyzeDates(1)
gistic <- getFirehoseData("GBM",gistic2Date = lastanalyzedate)

# 得到GISTIC结果
gistic.allbygene <- getData(gistic, type = "GISTIC", platform = "AllByGene")
gistic.thresholedbygene <- getData(gistic, type = "GISTIC", platform = "ThresholdedByGene")
```

```{R, eval=TRUE, message=FALSE, warning=FALSE, include=TRUE}
data(GBMGistic)
datatable(gistic.allbygene,
          filter = 'top',
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = FALSE)
datatable(gistic.thresholedbygene,
          filter = 'top',
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = FALSE)
```

## 基因组分析


在肿瘤的形成与发育过程中，拷贝数突变（CNVs）扮演着重要的角色。基因组重组可以引起染色体片段删
除或扩增，例如片段删除，片段复制，片段插入和片段易位。CNSs是一段超过1 
kb的基因组区域，在不同情况下（如肿瘤与正常情况）该区域发生拷贝数突变。




TCGA收集了拷贝数数据，建立了癌症CNV文库。癌症与与之配对的正常DNA样本经过微阵列芯片分析和测序
分析以达到探测CNV的目的。等级为3的已处理数据为基因组的非正常区域，该区域根据CNV分割而划分，
这些数据对于所有的拷贝数技术都是可获取的。



在本节，我们将会讲述如何分析来自TCGA等级为3的CNV数据，以此来鉴定癌症基因组中的复发性突变。我
们将从来自于SNP阵列（Affymetrix Genome-Wide Human SNP Array
6.0）的CNV数据入手。


### 预处理数据{#pre-processing-data .unnumbered}

TCGA中关于GBM的CNV平台只有“Affymetrix Genome-Wide Human SNP Array 
6.0”。通过TCGAbiolinks，我们可以从Legacy数据库下载得到20个原始实体肿瘤的CNV 
SNP6数据，这些数据被分级为Level 
3。已选择的这些样本的数可以被下载下来，生成rse对象据（RangedSummarizedExperiment）。


```{r results='hide', eval=FALSE, message=FALSE, warning=FALSE, include=TRUE}
library(TCGAbiolinks)
# 选择可用的普通CN技术用于GBM和LGG
#############################
##      CNV数据预处理      ##
#############################
query.gbm.nocnv <- GDCquery(project = "TCGA-GBM",
                            data.category = "Copy number variation",
                            legacy = TRUE,
                            file.type = "nocnv_hg19.seg",
                            sample.type = c("Primary solid Tumor"))
# 只选择20个样本以减少时间
query.gbm.nocnv$results[[1]] <- query.gbm.nocnv$results[[1]][1:20,]

GDCdownload(query.gbm.nocnv, files.per.chunk = 100)

gbm.nocnv <- GDCprepare(query.gbm.nocnv, save = TRUE, save.filename = "GBMnocnvhg19.rda")
```


### 癌症中复发CNV的鉴定
癌症相关的CNV在众多基因组分析中均有体现。最重要的复发CNV可以通过[GAIA](http://bioconductor.org/packages/gaia/) [@morganellagaia]进行鉴定，该过程为将统计假设框架扩展到考虑样本内均匀性的迭代的过程。 GAIA基于保守排列检验，这使得当代突变的概率分布估计成为一个非驱动因素。









TCGA中检索得到的数据段被用于生成一个矩阵，该矩阵包含所有关于异常区域所必需的信息。此外，GAIA
需要基因探针的诠释数据（每种CNV技术均有对应的数据），这些数据可以通过broadinstitute网站下载
获取。


```{r results='hide', eval=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=--=-==--=--==---=-=-=-=-=-=-=-=-=-=-=-=-=-=-=--=-==--=--==--
# 从broadinstitute网站检索hg19的探针注释文件
# 对于hg38的分析请参考：
# https://gdc.cancer.gov/about-data/data-harmonization-and-generation/gdc-reference-files
# 文件：SNP6 GRCh38 Liftover Probeset文件用于拷贝数变异分析
# -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=--=-==--=--==---=-=-=-=-=-=-=-=-=-=-=-=-=-=-=--=-==--=--==--
gdac.root <- "ftp://ftp.broadinstitute.org/pub/GISTIC2.0/hg19_support/"
file <- paste0(gdac.root, "genome.info.6.0_hg19.na31_minus_frequent_nan_probes_sorted_2.1.txt")
if(!file.exists(basename(file))) downloader::download(file, basename(file))
markersMatrix <-  readr::read_tsv(basename(file), col_names = FALSE, col_types = "ccn", progress = FALSE)
save(markersMatrix, file = "markersMatrix.rda", compress = "xz")
```

```{r, echo=TRUE, message=FALSE,warning=FALSE, include=TRUE}
cancer <- "GBM"
message(paste0("Starting ", cancer))

# 得到以上对象
data(GBMnocnvhg19)
data(markersMatrix)

# 添加标签（0为缺失，1为存在）
cnvMatrix <- cbind(cnvMatrix,Label=NA)
cnvMatrix[cnvMatrix[,"Segment_Mean"] < -0.3,"Label"] <- 0
cnvMatrix[cnvMatrix[,"Segment_Mean"] > 0.3,"Label"] <- 1
cnvMatrix <- cnvMatrix[!is.na(cnvMatrix$Label),]

# 去除“Segment_Mean”，改变列名称
cnvMatrix <- cnvMatrix[,-6]
colnames(cnvMatrix) <- c("Sample.Name", "Chromosome", "Start", "End", "Num.of.Markers", "Aberration")

# 把染色体编号“X”和“Y”替换为23和24
cnvMatrix[cnvMatrix$Chromosome == "X","Chromosome"] <- 23
cnvMatrix[cnvMatrix$Chromosome == "Y","Chromosome"] <- 24
cnvMatrix$Chromosome <- as.integer(cnvMatrix$Chromosome)

# 使用GAIA进行复发CNV的鉴定
colnames(markersMatrix) <- c("Probe.Name", "Chromosome", "Start")
unique(markersMatrix$Chromosome)
markersMatrix[markersMatrix$Chromosome == "X","Chromosome"] <- 23
markersMatrix[markersMatrix$Chromosome == "Y","Chromosome"] <- 24
markersMatrix$Chromosome <- as.integer(markersMatrix$Chromosome)
markerID <- paste(markersMatrix$Chromosome,markersMatrix$Start, sep = ":")
# 去除重复值
markersMatrix <- markersMatrix[!duplicated(markerID),]
# 过滤makersMatrix得到common CNV
markerID <- paste(markersMatrix$Chromosome,markersMatrix$Start, sep = ":")

file <- "ftp://ftp.broadinstitute.org/pub/GISTIC2.0/hg19_support/CNV.hg19.bypos.111213.txt"
if(!file.exists(basename(file))) downloader::download(file, basename(file))
commonCNV <- readr::read_tsv(basename(file), progress = FALSE)
commonID <- paste(commonCNV$Chromosome,commonCNV$Start, sep = ":")
markersMatrix_fil <- markersMatrix[!markerID %in% commonID,]

library(gaia)
set.seed(200)
markers_obj <- load_markers(as.data.frame(markersMatrix_fil))
nbsamples <- length(unique(cnvMatrix$Sample))
cnv_obj <- load_cnv(cnvMatrix, markers_obj, nbsamples)
suppressWarnings({
  results <- runGAIA(cnv_obj,
                     markers_obj,
                     output_file_name = paste0("GAIA_",cancer,"_flt.txt"),
                     aberrations = -1,  # -1 to all aberrations
                     chromosomes = 9, # -1 to all chromosomes
                     approximation = TRUE, # Set to TRUE to speed up the time requirements
                     num_iterations = 5000, # Reduced to speed up the time requirements
                     threshold = 0.25)
})
# 设置q-value阈值
# 对于你的分析可以使用较小值，我们设定了一个较高的值。
# 由于样本数目较少且没有重复
# 较小q-value的结果
threshold <- 0.3

# 绘制结果
RecCNV <- t(apply(results,1,as.numeric))
colnames(RecCNV) <- colnames(results)
RecCNV <- cbind(RecCNV, score = 0)
minval <- format(min(RecCNV[RecCNV[,"q-value"] != 0,"q-value"]), scientific = FALSE)
minval <- substring(minval,1, nchar(minval) - 1)
RecCNV[RecCNV[,"q-value"] == 0,"q-value"] <- as.numeric(minval)
RecCNV[,"score"] <- sapply(RecCNV[,"q-value"],function(x) -log10(as.numeric(x)))
RecCNV[RecCNV[,"q-value"] == as.numeric(minval),]

gaiaCNVplot(RecCNV,threshold)
save(results, RecCNV, threshold, file = paste0(cancer,"_CNV_results.rda"))
```

GBM中重复的扩增与缺失被鉴定出来，结果通过染色体全局绘图展示，其中*$-log_{10}$ corrected 
p-value*表示扩增，*$log_{10}$corrected p-value* 
表示缺失。被显著认定为拷贝数变异的区域被鉴定出来；$10^{-4}$被用于注释来表示扩增或被删除的基
因与癌症有很大关系。 




### 重复CNV的基因注释
癌症中不正常的重复基因区域通过GAIA被鉴别，这些区域需要被注释以此来判断哪些基因属于显著被扩增
，哪些区域被显著性删除。通过biomaRt，我们可以检索出人类基因在染色体上的覆盖区域，随后通过比
较它们以得到具有全部长度的基因。



```{r , eval = TRUE, message=FALSE,warning=FALSE, include=FALSE}
library(GenomicRanges)
```

```{r , eval = FALSE, message=FALSE,warning=FALSE, include=TRUE}
library(GenomicRanges)
# 通过biomart从GENCODE得到基因信息
genes <- TCGAbiolinks:::get.GRCh.bioMart(genome = "hg19") 
genes <- genes[genes$external_gene_id != "" & genes$chromosome_name %in% c(1:22,"X","Y"),]
genes[genes$chromosome_name == "X", "chromosome_name"] <- 23
genes[genes$chromosome_name == "Y", "chromosome_name"] <- 24
genes$chromosome_name <- sapply(genes$chromosome_name,as.integer)
genes <- genes[order(genes$start_position),]
genes <- genes[order(genes$chromosome_name),]
genes <- genes[,c("external_gene_id", "chromosome_name", "start_position","end_position")]
colnames(genes) <- c("GeneSymbol","Chr","Start","End")
genes_GR <- makeGRangesFromDataFrame(genes,keep.extra.columns = TRUE)
save(genes_GR,genes,file = "genes_GR.rda", compress = "xz")
```


```{r , echo=TRUE, message=FALSE,warning=FALSE, include=TRUE}
##############################
## Recurrent CNV annotation ## 
##############################
# Get gene information from GENCODE using biomart
data(genes_GR) # downloaded in the previous step (available in TCGAWorkflowData)

load(paste0(cancer,"_CNV_results.rda"))
sCNV <- RecCNV[RecCNV[,"q-value"] <= threshold,c(1:4,6)]
sCNV <- sCNV[order(sCNV[,3]),]
sCNV <- sCNV[order(sCNV[,1]),]
colnames(sCNV) <- c("Chr","Aberration","Start","End","q-value")
sCNV_GR <- makeGRangesFromDataFrame(sCNV,keep.extra.columns = TRUE)

hits <- findOverlaps(genes_GR, sCNV_GR, type = "within")
sCNV_ann <- cbind(sCNV[subjectHits(hits),],genes[queryHits(hits),])
AberrantRegion <- paste0(sCNV_ann[,1],":",sCNV_ann[,3],"-",sCNV_ann[,4])
GeneRegion <- paste0(sCNV_ann[,7],":",sCNV_ann[,8],"-",sCNV_ann[,9])
AmpDel_genes <- cbind(sCNV_ann[,c(6,2,5)],AberrantRegion,GeneRegion)
AmpDel_genes[AmpDel_genes[,2] == 0,2] <- "Del"
AmpDel_genes[AmpDel_genes[,2] == 1,2] <- "Amp"
rownames(AmpDel_genes) <- NULL

save(RecCNV, AmpDel_genes, file = paste0(cancer,"_CNV_results.rda"))
```
```{r results='asis', echo=FALSE, message=FALSE, warning=FALSE}
knitr::kable(head(AmpDel_genes), caption = "Chromosome 9 recurrent deleted genes in LGG")
```


### 可视化多基因变异

为了对于多个基因组变异进行可视化，我们建议使用maftools进行绘图，该软件由Bioconductor平台提供
[maftools](http://bioconductor.org/packages/maftools/)
[@mayakonda2016maftools]。下面展示如何使用*GDCquery\_maf*下载突变数据（第四行）以及使用mafto
ols准备。


```{r results='hide', echo=TRUE, message=FALSE, warning=FALSE, eval = FALSE}
library(maftools)
# 下载Mutation Annotation Format (MAF) 文件
LGGmut <- GDCquery_Maf(tumor = "LGG", pipelines = "mutect2")
GBMmut <- GDCquery_Maf(tumor = "GBM", pipelines = "mutect2")

# 融合
mut <- plyr::rbind.fill(LGGmut, GBMmut)
save(maf,file ="mafMutect2LGGGBM.rda", compress = "xz")
```

read.maf函数用于准备MAF数据从而可以maftools分析，我们还需要临床数据以进行生存分析绘图。


```{r results='hide', echo=TRUE, message=FALSE, warning=FALSE}
library(maftools)
# 从TCGAWorkflowData恢复数据
data(mafMutect2LGGGBM)

# To prepare for maftools we will also include clinical data
# For a mutant vs WT survival analysis 
# get indexed clinical patient data for GBM samples
gbm_clin <- GDCquery_clinic(project = "TCGA-GBM", type = "Clinical")
# get indexed clinical patient data for LGG samples
lgg_clin <- GDCquery_clinic(project = "TCGA-LGG", type = "Clinical")
# Bind the results, as the columns might not be the same,
# we will will plyr rbind.fill, to have all columns from both files
clinical <- plyr::rbind.fill(gbm_clin,lgg_clin)
colnames(clinical)[1] <- "Tumor_Sample_Barcode"
clinical$Overall_Survival_Status <- 1
clinical$Overall_Survival_Status[which(clinical$vital_status != "dead")] <- 0
clinical$time <- clinical$days_to_death
clinical$time[is.na(clinical$days_to_death)] <- clinical$days_to_last_follow_up[is.na(clinical$days_to_death)]

# Create object to use in maftools
maf <- read.maf(maf = mut, clinicalData = clinical, isTCGA = T)
```

我们可以绘制MAF汇总信息。
```{r echo=TRUE, message=FALSE, warning=FALSE,fig.width=10}
plotmafSummary(maf = maf,
               rmOutlier = TRUE,
               addStat = 'median',
               dashboard = TRUE)
```

我们可以绘制oncoplot以表现排名前20的变异基因，进而添加注释信息，如分子亚型等。

```{r echo=TRUE, message=FALSE, warning=FALSE,fig.height=10,fig.width=15,eval=FALSE}
oncoplot(maf = maf,
         top = 20,
         legendFontSize = 8,
         clinicalFeatures = c("tissue_or_organ_of_origin")
         )
```

基于基因的变异地位，我们也可以绘制通过分组样本进行生存分析的绘制。

```{r echo=TRUE, message=FALSE, warning=FALSE}
plot <- mafSurvival(maf = maf,
                   genes = "IDH1",
                   fn = NULL,
                   time = 'time',
                   Status = 'Overall_Survival_Status',
                   isTCGA = TRUE)
```
        
**Overview of genomic alterations by circos plot**

癌症中的基因组变异包含CNV和变异，这些信息可以通过circos绘图进行展示。我们使用[circlize](http
s://cran.r-project.org/web/packages/circlize/index.html)CRAN包来展示LGG中显著的CNV（GAIA分析
结果）和重复变异（选择TCGA中至少两个肿瘤样本可以检索到的基因变异）。Circos绘图可以表明全基因
组水平的分子变化或者仅仅是我们所选择的一至两个染色体。






```{r results='hide', eval = FALSE, echo=TRUE, message=FALSE,warning=FALSE}
LGGmut <- GDCquery_Maf(tumor = "LGG", pipelines = "mutect2")
```

```{r results='hide', echo=TRUE, message=FALSE,warning=FALSE}
###############################################
## Genomic aberration overview - Circos plot ## 
###############################################
# Retrieve curated mutations for selected cancer (e.g. "LGG") 
data(mafMutect2LGGGBM)
# Select only potentially damaging mutations
LGGmut <- LGGmut[LGGmut$Variant_Classification %in% c("Missense_Mutation",
                                                      "Nonsense_Mutation",
                                                      "Nonstop_Mutation",
                                                      "Frame_Shift_Del",
                                                      "Frame_Shift_Ins"),]
# Select recurrent mutations (identified in at least two samples)
mut.id <- paste0(LGGmut$Chromosome,":",LGGmut$Start_Position,"-",LGGmut$End_Position,"|",LGGmut$Reference_Allele)
mut <- cbind(mut.id, LGGmut)
# Prepare selected mutations data for circos plot
s.mut <- mut[mut$mut.id %in% unique(mut.id[duplicated(mut.id)]),]
s.mut <- s.mut[,c("Chromosome","Start_Position","End_Position","Variant_Classification","Hugo_Symbol")]
s.mut <- unique(s.mut)
typeNames <- unique(s.mut[,4])
type <- c(4:1)
names(type) <- typeNames[1:4]
Type <- type[s.mut[,4]]
s.mut <- cbind(s.mut,Type)
s.mut <- s.mut[,c(1:3,6,4,5)]

# Load recurrent CNV data for selected cancer (e.g. "LGG")
load("GBM_CNV_results.rda")
# Prepare selected sample CNV data for circos plot
s.cnv <- as.data.frame(RecCNV[RecCNV[,"q-value"] <= threshold,c(1:4,6)])
s.cnv <- s.cnv[,c(1,3,4,2)]
s.cnv[s.cnv$Chromosome == 23,"Chromosome"] <- "X"
s.cnv[s.cnv$Chromosome == 24,"Chromosome"] <- "Y"
Chromosome <- paste0("chr",s.cnv[,1])
s.cnv <- cbind(Chromosome, s.cnv[,-1])
s.cnv[,1] <- as.character(s.cnv[,1])
s.cnv[,4] <- as.character(s.cnv[,4])
s.cnv <- cbind(s.cnv,CNV=1)
colnames(s.cnv) <- c("Chromosome","Start_position","End_position","Aberration_Kind","CNV")

library(circlize)
# Draw genomic circos plot
par(mar=c(1,1,1,1), cex=1)
circos.initializeWithIdeogram()
# Add CNV results
colors <- c("forestgreen","firebrick")
names(colors)  <- c(0,1)
circos.genomicTrackPlotRegion(s.cnv,  ylim = c(0,1.2),
                              panel.fun = function(region, value, ...) {
                                circos.genomicRect(region, value, ytop.column = 2, ybottom = 0,
                                                   col = colors[value[[1]]], 
                                                   border="white")
                                cell.xlim = get.cell.meta.data("cell.xlim")
                                circos.lines(cell.xlim, c(0, 0), lty = 2, col = "#00000040")
                              })
# Add mutation results
colors <- c("blue","green","red","gold")
names(colors)  <- typeNames[1:4]
circos.genomicTrackPlotRegion(s.mut, ylim = c(1.2,4.2),
                              panel.fun = function(region, value, ...) {
                                circos.genomicPoints(region, value, cex = 0.8, pch = 16, col = colors[value[[2]]], ...)
                              })

circos.clear()

legend(-0.2, 0.2, bty="n", y.intersp=1, c("Amp","Del"), pch=15, 
       col=c("firebrick","forestgreen"), title="CNVs", text.font=1, cex=0.4, title.adj=0)
legend(-0.2, 0, bty="n", y.intersp=1, names(colors), pch=16, 
       col=colors, title="Mutations", text.font=1, cex=0.4, title.adj=0)
```

```{r results='asis', echo=TRUE, message=FALSE,warning=FALSE}
par(mar=c(1,1,1,1),cex=1.5)
circos.par("start.degree" = 90, canvas.xlim = c(0, 1), canvas.ylim = c(0, 1), 
           gap.degree = 270, cell.padding = c(0, 0, 0, 0), track.margin = c(0.005, 0.005))
circos.initializeWithIdeogram(chromosome.index = "chr17")
circos.par(cell.padding = c(0, 0, 0, 0))
# Add CNV results
colors <- c("forestgreen","firebrick")
names(colors)  <- c(0,1)
circos.genomicTrackPlotRegion(s.cnv,  ylim = c(0,1.2),
                              panel.fun = function(region, value, ...) {
                                circos.genomicRect(region, value, ytop.column = 2, ybottom = 0,
                                                   col = colors[value[[1]]], 
                                                   border="white")
                                cell.xlim = get.cell.meta.data("cell.xlim")
                                circos.lines(cell.xlim, c(0, 0), lty = 2, col = "#00000040")
                              })

# Add mutation results representing single genes
genes.mut <- paste0(s.mut$Hugo_Symbol,"-",s.mut$Type)
s.mutt <- cbind(s.mut,genes.mut)
n.mut <- table(genes.mut)
idx <- !duplicated(s.mutt$genes.mut)
s.mutt <- s.mutt[idx,]
s.mutt <- cbind(s.mutt,num=n.mut[s.mutt$genes.mut])
genes.num <- paste0(s.mutt$Hugo_Symbol," (",s.mutt$num.Freq,")")
s.mutt <- cbind(s.mutt[,-c(6:8)],genes.num)
s.mutt[,6] <- as.character(s.mutt[,6])
s.mutt[,4] <- s.mutt[,4]/2
s.mutt$num.Freq <- NULL
colors <- c("blue","green","red","gold")
names(colors)  <- typeNames[1:4]
circos.genomicTrackPlotRegion(s.mutt, ylim = c(0.3,2.2), track.height = 0.05,
                              panel.fun = function(region, value, ...) {
                                circos.genomicPoints(region, value, cex = 0.4, pch = 16, col = colors[value[[2]]], ...)
                              })

circos.genomicTrackPlotRegion(s.mutt, ylim = c(0, 1), track.height = 0.1, bg.border = NA)
i_track = get.cell.meta.data("track.index")

circos.genomicTrackPlotRegion(s.mutt, ylim = c(0,1),
                              panel.fun = function(region, value, ...) {
                                circos.genomicText(region, value, 
                                                   y = 1, 
                                                   labels.column = 3,
                                                   col = colors[value[[2]]],
                                                   facing = "clockwise", adj = c(1, 0.5),
                                                   posTransform = posTransform.text, cex = 0.4, niceFacing = TRUE)
                              }, track.height = 0.1, bg.border = NA)

circos.genomicPosTransformLines(s.mutt,
                                posTransform = function(region, value)
                                  posTransform.text(region, 
                                                    y = 1, 
                                                    labels = value[[3]],
                                                    cex = 0.4, track.index = i_track+1),
                                direction = "inside", track.index = i_track)

circos.clear()

legend(0.25, 0.2, bty="n", y.intersp=1, c("Amp","Del"), pch=15, 
       col=c("firebrick","forestgreen"), title="CNVs", text.font=1, cex=0.4, title.adj=0)
legend(0, 0.2, bty="n", y.intersp=1, names(colors), pch=16, 
       col=colors, title="Mutations", text.font=1, cex=0.4, title.adj=0)
```


## 转录组分析

### 数据预处理

[LGG](https://gdc-portal.nci.nih.gov/legacy-archive/search/f?filters=%7B%22op%22:%22and%22,%22content%22:%5B%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22cases.project.project_id%22,%22value%22:%5B%22TCGA-LGG%22%5D%7D%7D,%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22files.data_category%22,%22value%22:%5B%22Gene%20expression%22%5D%7D%7D,%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22files.data_type%22,%22value%22:%5B%22Gene%20expression%20quantification%22%5D%7D%7D,%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22files.platform%22,%22value%22:%5B%22Illumina%20HiSeq%22%5D%7D%7D%5D%7D)
和
[GBM](https://gdc-portal.nci.nih.gov/legacy-archive/search/f?filters=%7B%22op%22:%22and%22,%22content%22:%5B%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22cases.project.project_id%22,%22value%22:%5B%22TCGA-GBM%22%5D%7D%7D,%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22files.data_category%22,%22value%22:%5B%22Gene%20expression%22%5D%7D%7D,%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22files.data_type%22,%22value%22:%5B%22Gene%20expression%20quantification%22%5D%7D%7D,%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22files.platform%22,%22value%22:%5B%22Illumina%20HiSeq%22%5D%7D%7D%5D%7D)
数据被用于接下来的转录组分析，数据通过TCGAbiolinks下载。我们只下载原始的实体肿瘤（TP）样本，其中LGG包含516例，GBM包含156例，随后我们把它们分成两个rse对象(*RangedSummarizedExperiment*)并保存在R对象中，文件名包含两个癌种名称以及基因表达数据所属平台的名称，详情见下。










```{R, eval=FALSE, include=TRUE}
query <- GDCquery(project = "TCGA-GBM",
                  data.category = "Gene expression",
                  data.type = "Gene expression quantification",
                  platform = "Illumina HiSeq", 
                  file.type  = "results", 
                  sample.type = c("Primary solid Tumor"),
                  legacy = TRUE)
# We will use only 20 samples to make the example faster
query$results[[1]] <-  query$results[[1]][1:20,]                  
GDCdownload(query)
gbm.exp <- GDCprepare(query, 
                      save = TRUE, 
                      summarizedExperiment = TRUE, 
                      save.filename = "GBMIllumina_HiSeq.rda")

query <- GDCquery(project = "TCGA-LGG",
                  data.category = "Gene expression",
                  data.type = "Gene expression quantification",
                  platform = "Illumina HiSeq", 
                  file.type  = "results", 
                  sample.type = c("Primary solid Tumor"),
                  legacy = TRUE)
# We will use only 20 samples to make the example faster
query$results[[1]] <-  query$results[[1]][1:20,]
GDCdownload(query)
lgg.exp <- GDCprepare(query, 
                      save = TRUE, 
                      summarizedExperiment = TRUE, 
                      save.filename = "LGGIllumina_HiSeq.rda")
```
数据预处理的第一步，我们需要使用*TCGAanalyze\_Preprocessing*函数找出可能的离群值，该函数用于
得到Array Array Intensity correlation 
AAIC（下面所列的第14-17行和26-29行）。通过该途径我们将定义一个对称矩阵，使用每个癌症种类（LG
G和GBM）的样品间皮尔森相关系数进行填充。该矩阵结果表明有0个样本的相关性系数低于0.6.即设定可
能为离群值的阈值。



第二步，我们将使用*TCGAanalyze\_Normalization*函数，该函数包括[EDASeq](http://bioconductor.o
rg/packages/EDASeq/)包的功能，我们可以用来对mRNA转库本进行标准化。 



该函数通过泳道内标准化过程以调整GC含量（或者其他基因水平的影响）对于原始片段计数的影响：拟合
鲁棒局部回归（loess robust local regression）， 
全局评估（global-scaling）和全分位数标准化（full-quantile normalization） 
[@risso2011gc]，以及泳道间标准化过程调整泳道间的分布差异（例如测序深度）：全局评估（global-s
caling）和全分位数标准化[@bullard2010evaluation]。



```{r results='asis', echo=TRUE, message=FALSE,warning=FALSE}
data("LGGIllumina_HiSeq")
data("GBMIllumina_HiSeq")

dataPrep_LGG <- TCGAanalyze_Preprocessing(object = lgg.exp,
                                          cor.cut = 0.6,    
                                          datatype = "raw_count",
                                          filename = "LGG_IlluminaHiSeq_RNASeqV2.png")

dataPrep_GBM <- TCGAanalyze_Preprocessing(object = gbm.exp,
                                          cor.cut = 0.6, 
                                          datatype = "raw_count",
                                          filename = "GBM_IlluminaHiSeq_RNASeqV2.png")

dataNorm <- TCGAanalyze_Normalization(tabDF = cbind(dataPrep_LGG, dataPrep_GBM),
                                      geneInfo = TCGAbiolinks::geneInfo,
                                      method = "gcContent") #18323   672

dataFilt <- TCGAanalyze_Filtering(tabDF = dataNorm,
                                  method = "quantile",
                                  qnt.cut =  0.25)  # 13742   672

save(dataFilt, file = paste0("LGG_GBM_Norm_IlluminaHiSeq.rda"))

dataFiltLGG <- subset(dataFilt, select = substr(colnames(dataFilt),1,12) %in% lgg_clin$bcr_patient_barcode)
dataFiltGBM <- subset(dataFilt, select = substr(colnames(dataFilt),1,12) %in% gbm_clin$bcr_patient_barcode)

dataDEGs <- TCGAanalyze_DEA(mat1 = dataFiltLGG,
                            mat2 = dataFiltGBM,
                            Cond1type = "LGG",
                            Cond2type = "GBM",
                            fdr.cut = 0.01 ,
                            logFC.cut = 1,
                            method = "glmLRT")

```

```{r results='asis', echo=TRUE, message=FALSE,warning=FALSE}
# Number of differentially expressed genes (DEG)
nrow(dataDEGs)
```


### EA：富集分析
为了理解差异表达基因（DEGs）的潜在生物学过程，我们需要使用*TCGAanalyze\_EA\_complete*函数进
行富集分析。


```{r results='hide', echo=TRUE, message=FALSE,warning=FALSE,fig.height=10, fig.width=10}
#-------------------  4.2 EA: enrichment analysis             --------------------
ansEA <- TCGAanalyze_EAcomplete(TFname="DEA genes LGG Vs GBM", RegulonList = rownames(dataDEGs))
TCGAvisualize_EAbarplot(tf = rownames(ansEA$ResBP),
                        filename = NULL,
                        GOBPTab = ansEA$ResBP, 
                        nRGTab = rownames(dataDEGs),
                        nBar = 20)
```
```{r results='hide', echo=TRUE, message=FALSE,warning=FALSE,fig.height=10, fig.width=10}
TCGAvisualize_EAbarplot(tf = rownames(ansEA$ResBP),
                        filename = NULL,
                        GOCCTab = ansEA$ResCC,
                        nRGTab = rownames(dataDEGs),
                        nBar = 20)
```

```{r results='hide', echo=TRUE, message=FALSE,warning=FALSE,fig.height=10, fig.width=10}
TCGAvisualize_EAbarplot(tf = rownames(ansEA$ResBP),
                        filename = NULL,
                        GOMFTab = ansEA$ResMF, 
                        nRGTab = rownames(dataDEGs),
                        nBar = 20)
```

```{r results='hide', echo=TRUE, message=FALSE,warning=FALSE,fig.height=12, fig.width=15}
TCGAvisualize_EAbarplot(tf = rownames(ansEA$ResBP),
                        filename = NULL,
                        PathTab = ansEA$ResPat,
                        nRGTab = rownames(dataDEGs),
                        nBar = 20)
```

该图展示了DEGs富集所得到的经典通路以及对应的基因个数，这些通路主要来自于三个本体（GO：生物学
过程，GO：细胞组成成分和GO：分子功能）。根据p-value修订后的FDR（-Log）（彩色的条形）以及基因
对于该通路所有基因所占的比例（比例，红线），我们可以得到DEGs富集出的最显著的经典通路。]




*TCGAanalyze\_EAbarplot*将会生成一个柱形图，图上标出了在三个本体主要分类中基因的个数。

该图展示了DEGs富集得到的显著高表达经典通路。这些由DEGs富集得到的通路根据p-value矫正后得到的FDR以及基因在通路中所有基因所占比例进行排序。










### PEA：通路富集分析

为了验证找到的基因是否在通路中有特定的功能，Bioconductor平台的 
[pathview](http://bioconductor.org/packages/pathview/)
[@luo2013pathview]可以实现我们的目标。下面举例如何使用该包。例如，它可以接受一个包含基因名字
的向量和这些基因的表达水平，在[KEGG 
database](http://www.genome.jp/kegg/pathway.html)中的通路编号，物种名称（hsa为智人）和基因表
达的范围。



```{r results='asis', echo=TRUE, message=FALSE,warning=FALSE}
library(SummarizedExperiment)
GenelistComplete <- rownames(assay(lgg.exp,1))

# DEGs TopTable
dataDEGsFiltLevel <- TCGAanalyze_LevelTab(dataDEGs,"LGG","GBM",
                                          dataFilt[,colnames(dataFiltLGG)],
                                          dataFilt[,colnames(dataFiltGBM)])

dataDEGsFiltLevel$GeneID <- 0

library(clusterProfiler)
# Converting Gene symbol to geneID
eg = as.data.frame(bitr(dataDEGsFiltLevel$mRNA,
                        fromType="SYMBOL",
                        toType="ENTREZID",
                        OrgDb="org.Hs.eg.db"))
eg <- eg[!duplicated(eg$SYMBOL),]

dataDEGsFiltLevel <- dataDEGsFiltLevel[dataDEGsFiltLevel$mRNA %in% eg$SYMBOL,]

dataDEGsFiltLevel <- dataDEGsFiltLevel[order(dataDEGsFiltLevel$mRNA,decreasing=FALSE),]
eg <- eg[order(eg$SYMBOL,decreasing=FALSE),]

# table(eg$SYMBOL == dataDEGsFiltLevel$mRNA) should be TRUE
all(eg$SYMBOL == dataDEGsFiltLevel$mRNA)
dataDEGsFiltLevel$GeneID <- eg$ENTREZID

dataDEGsFiltLevel_sub <- subset(dataDEGsFiltLevel, select = c("GeneID", "logFC"))
genelistDEGs <- as.numeric(dataDEGsFiltLevel_sub$logFC)
names(genelistDEGs) <- dataDEGsFiltLevel_sub$GeneID
library(pathview)
# pathway.id: hsa05214 is the glioma pathway
# limit: sets the limit for gene expression legend and color
hsa05214 <- pathview::pathview(gene.data  = genelistDEGs,
                               pathway.id = "hsa05214",
                               species    = "hsa",
                               limit = list(gene=as.integer(max(abs(genelistDEGs)))))

```

红色的基因LGG相较于GBM的上调基因，绿色的基因LGG相较于GBM的下调基因。


![\label{gliomapathview} Pathways enrichment analysis: glioma pathway. Red defines genes that are up-regulated and green defines genes that are down-regulated.](hsa05214.pathview.png)

### 基因调控网络的推断


由差异表达基因出发，我们使用一下最先进的算法来推断基因调控网络：ARACNE 
[@margolin2006aracne]，CLR [@faith2007large]，MRNET
[@meyer2007information]和C3NET 
[@altay2010inferring]。这些方法基于相互干扰，使用不同的启发方法推断网络的边
缘。这些方法可以通过Bioconductor/CRAN包([MINET](http://bioconductor.org/pac
kages/minet/) [@Meyer2008]和[c3net](https://cran.r-project.org/web/packages
/c3net/index.html) [@altay2010inferring])实现。很多基因的相互调控作用已经通
过实验验证并发表。这些已知的相互作用可以通过不同的工具和数据库得到，如BioGr
id [@Stark01012006] 或 GeneMANIA 
[@montojo2010genemania]。然而，这些信息远远还未完成，许多情况下只包含了真正
的相互作用的一小部分。通过与已经经过验证的相互作用比较，我们可以对于得到的
调控网络进行质量评估。比较的结果如下表所示。








validated   not validated/non-existing
-------------- ----------- ----------------------------
inferred           TP                   FP
not inferred       FN                   TN

：混淆矩阵（Confusion 
matrix）用于比较推断网络和以验证过相互关系的网络。<span 
data-label="table::confusion_matrix"></span>
不同的质量评估可以通过以下几种方式获得：假阳性率$$fpr=\frac{FP}{FP+TN}$$，
真阳性率（也被称作召回率）$$tpr=\frac{TP}{TP+FN}$$以及精确度$$p=\frac{TP}{T
P+FP}$$。算法的表现可以通过使用ROC（假阳性率vs真阳性率）进行评估总结。




这类比较的一个弱点是，在已知交互集中不存在的边缘，要么意味着已经进行了实验
验证，但没有显示任何调节机制，要么(更有可能)尚未进行尝试。接下来，我们将要
使用来自于转录组分析中得到的2901个差异表达基因进行nce分析。

**检索已知的相互作用关系**





我们从[BioGrid database](http://thebiogrid.org/)得到了一套已知的相互作用关
系。

在2901个差异表达基因中存在3941个唯一的相互作用关系。


**使用来自于TCGAbiolinks流程的差异表达基因**

我们通过推断LGG数据的一个基因集开始分析。

```{R, eval=FALSE, include=TRUE}
### read biogrid info (available in TCGAWorkflowData as "biogrid")
### Check last version in https://thebiogrid.org/download.php 
file <- "http://thebiogrid.org/downloads/archives/Release%20Archive/BIOGRID-3.4.146/BIOGRID-ALL-3.4.146.tab2.zip"
if(!file.exists(gsub("zip","txt",basename(file)))){
  downloader::download(file,basename(file))
  unzip(basename(file),junkpaths =TRUE)
}

tmp.biogrid <- read.csv(gsub("zip","txt",basename(file)), header=TRUE, sep="\t", stringsAsFactors=FALSE)
```

```{R, eval=TRUE, include=TRUE}
### plot details (colors & symbols)
mycols <- c('#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628')

### load network inference libraries
library(minet)
library(c3net)

### deferentially identified genes using TCGAbiolinks
# we will use only a subset (first 50 genes) of it to make the example faster
names.genes.de <- rownames(dataDEGs)[1:30]

data(biogrid)
net.biogrid.de <- getAdjacencyBiogrid(tmp.biogrid, names.genes.de)

mydata <- dataFiltLGG[names.genes.de, ]

### infer networks
t.mydata <- t(mydata)
net.aracne <- minet(t.mydata, method = "aracne")
net.mrnet <- minet(t.mydata)
net.clr <- minet(t.mydata, method = "clr")
net.c3net <- c3net(mydata)

### validate compared to biogrid network
tmp.val <- list(validate(net.aracne, net.biogrid.de), 
                validate(net.mrnet, net.biogrid.de),
                validate(net.clr, net.biogrid.de), 
                validate(net.c3net, net.biogrid.de))

### plot roc and compute auc for the different networks
dev1 <- show.roc(tmp.val[[1]],cex=0.3,col=mycols[1],type="l")
res.auc <- auc.roc(tmp.val[[1]])
for(count in 2:length(tmp.val)){
  show.roc(tmp.val[[count]],device=dev1,cex=0.3,col=mycols[count],type="l")
  res.auc <- c(res.auc, auc.roc(tmp.val[[count]]))
}

legend("bottomright", legend=paste(c("aracne","mrnet","clr","c3net"), signif(res.auc,4), sep=": "),
       col=mycols[1:length(tmp.val)],lty=1, bty="n" )
# Please, uncomment this line to produce the pdf files.
# dev.copy2pdf(width=8,height=8,device = dev1, file = paste0("roc_biogrid_",cancertype,".pdf"))
```


![ROC with corresponding AUC for inferred GBM networks compared to
BioGrid interactions\label{fig::roc_GBM}](roc_biogrid_GBM.png)

再上图中，我们得到了ROC曲线以及相应的AUC（曲线下方区域的面积）。 
可以看出，在比较推断网络与BioGrid数据库中的已知相互作用比较时，CLR和MRNET表
现得最为出色。



## 表观遗传学分析

在众多细胞生命活动中，DNA的甲基化是非常重要的一个环节，例如胚胎发育，基因铭
记，X染色体失活以及染色体稳定性的保持[@phillips2008role]。



在哺乳动物中，DNA甲基化相对贫乏但是分布广泛，在整个基因组里，可以发现它们一
定发生在CpG序列中；当然也会有例外发生。CpG岛（CGIs）是一段较短的穿插DNA序列
，其中富集了大量的GC。这些CpG岛一般发现于转录起始区域，它们的甲基化可以引起
基因沉默[@deaton2011cpg]。



因此，DNA甲基化的探究对于理解癌症中的基因网络调控非常重要，因为DNA甲基化可
以抑制转录翻译的发生[@robertson2005dna]。所以DMR（差异甲基化区域）的确定可
以帮助我们探究基因网络调控。



本节我们将会使用Bioconductor的[TCGAbiolinks](http://bioconductor.org/packag
es/TCGAbiolinks/)[@TCGAbiolinks]进行甲基化分析。由于时间限制，本分析只选用1
0个LGG样本和10个GBM样本的DNA甲基化数据。甲基化数据来自于Infinium 
HumanMethylation450芯片，基因表达量来自于Illumina HiSeq 2000 RNA Sequencing Version 2(第1-56行描述了如何获取数据）。首先我们将检查样本不同分组的DNA甲基
化平均值，之后进行差异甲基化区域分析，我们将试图寻找一些有可能对生命活动非
常关键的区域（例如，在一组中时甲基化的区域而在另一组中没有甲基化），在找寻
到这些区域后，我们可以通过热图的形式来展现它们。







### 对于每一个病人的平均甲基化水平进行可视化

首先我们需要声明的是DNA甲基化数据的预处理工作已经完成了。450K平台的DNA甲基
化数据有三种类型的探针，分别是cg（CpG位点），ch（非CpG位点）和rs（SNP测试）
。最后一种探针可以用于样本的区分和追踪。在进行差异甲基化区域分析的时候，根
据ilumina手册，我们应该排除这一类探针。因此，rs探针被删除（详见68行）。除此
之外，染色体X、Y中的探针也被移除，以消除由不同比例的男性和女性存在而产生的
潜在假象[@marabita2013evaluation]。最后一步预处理是删除掉含有至少一个NA的探
针（详见65行）。







在完成预处理环节后，我们使用*TCGAvisualize\_meanMethylation*函数来检查每一
组中每个病人的DNA甲基化平均水平。该函数使用参数*SummarizedExperiment*接收DN
A甲基化数据， *groupCol* 和*subgroupCol*参数应该为 
*SummarizedExperiment*参数对象中的矩阵中的两列，它们是关于病人的信息。（通
过*colData*函数获取）（详见70-74行）。




```{R, eval=FALSE, include=TRUE}
#----------------------------
# Obtaining DNA methylation
#----------------------------
# Samples
lgg.samples <- matchedMetExp("TCGA-LGG", n = 10)
gbm.samples <- matchedMetExp("TCGA-GBM", n = 10)
samples <- c(lgg.samples,gbm.samples)

#-----------------------------------
# 1 - Methylation
# ----------------------------------
# For methylation it is quicker in this case to download the tar.gz file
# and get the samples we want instead of downloading files by files
query <- GDCquery(project = c("TCGA-LGG","TCGA-GBM"),
                  data.category = "DNA methylation",
                  platform = "Illumina Human Methylation 450",
                  legacy = TRUE, 
                  barcode = samples)
GDCdownload(query)
met <- GDCprepare(query, save = FALSE)

# We will use only chr9 to make the example faster
met <- subset(met,subset = as.character(seqnames(met)) %in% c("chr9"))
# This data is avaliable in the package (object elmerExample)
```

```{r echo=TRUE, message=FALSE,warning=FALSE, fig.height=8,fig.width=8}
data(elmerExample)
#----------------------------
# Mean methylation
#----------------------------
# Plot a barplot for the groups in the disease column in the
# summarizedExperiment object

# remove probes with NA (similar to na.omit)
met <- subset(met,subset = (rowSums(is.na(assay(met))) == 0))

TCGAvisualize_meanMethylation(met,
                              groupCol = "project_id",
                              group.legend  = "Groups",
                              filename = NULL,
                              print.pvalue = TRUE)
```

上图展示了GBM（140个样品）和LGG两个分组中每个样本的平均甲基化水平。数据的全
基因组视图强调了癌症组间的差异。



### 寻找差异甲基化CpG位点

下一步将进行两组之间的差异甲基化CpG位点。可以使用*TCGAanalyze\_DMR*函数完成
（详见下表）。DNA甲基化数据（等级3）通过beta值的方式展现，该值的取值范围为0
.0（探针为完全非甲基化）到1（探针全部被甲基化）。




为了得到这些差异甲基化CpG位点，首先，该函数计算了每组每个探针DNA甲基化平均
值的差值。然后，使用经过Benjamini-Hocjberg方法修正的Wilcoxon检验来检测两组
之间的差异。TCGAanalyze\_DMR的参数需要设置为最小Beta插值的绝对值为0.15且修
正后的p值小于$0.05$。




在这些检验之后，我们绘制了一个火山图（x轴：DNA甲基化均值的差异，y轴：统计学
显著性）来帮助使用者区分差异甲基化CpG位点，并得到结果对象。



```{r results='hide', echo=TRUE, message=FALSE,warning=FALSE}
#------- Searching for differentially methylated CpG sites     ----------
met <- TCGAanalyze_DMR(met,
                       groupCol = "project_id", # a column in the colData matrix
                       group1 = "TCGA-GBM", # a type of the disease type column
                       group2 = "TCGA-LGG", # a type of the disease column
                       p.cut = 0.05,
                       diffmean.cut = 0.15,
                       save = FALSE,
                       legend = "State",
                       plot.filename = "LGG_GBM_metvolcano.png",
                       cores = 1 # if set to 1 there will be a progress bar
)
```

下图展示了经过以下操作得到的火山图。这个图可以帮助用户选择相关的阈值以此来搜索具有生物学意义的候选DMRs。

![Volcano plot: searching for differentially methylated
CpG sites (x-axis:difference of mean DNA methylation, y-axis:
statistical
significance)](LGG_GBM_metvolcano.png)




为了进行全样品中这些探针的DNA甲基化水平，我们使用[complexHeatmap](http://bi
oconductor.org/packages/ComplexHeatmap/)[@ComplexHeatmap]来制作热图。通过[c
omplexHeatmap](http://bioconductor.org/packages/ComplexHeatmap/)包绘制热图
，用户至少需要提供一个DNA甲基化水平的表达矩阵。除此之外，还需要添加图层注释
并把它们放置在热图四周以提供额外的注释信息。下面的代码将会绘制这样一个关于D
NA甲基化位点的热图。







```{r results='hide', echo=TRUE, message=FALSE,warning=FALSE}
#--------------------------
# DNA Methylation heatmap
#-------------------------
library(ComplexHeatmap)
clinical <- plyr::rbind.fill(gbm_clin,lgg_clin)

# get the probes that are Hypermethylated or Hypomethylated
# met is the same object of the section 'DNA methylation analysis'
status.col <- "status.TCGA.GBM.TCGA.LGG"
sig.met <- met[values(met)[,status.col] %in% c("Hypermethylated","Hypomethylated"),]


# top annotation, which sampples are LGG and GBM
# We will add clinical data as annotation of the samples
# we will sort the clinical data to have the same order of the DNA methylation matrix
clinical.order <- clinical[match(substr(colnames(sig.met),1,12),clinical$bcr_patient_barcode),]
ta = HeatmapAnnotation(df = clinical.order[,c("disease","gender","vital_status","race")],
                       col = list(disease = c("LGG" = "grey", "GBM" = "black"),
                                  gender = c("male" = "blue","female" = "pink")))

# row annotation: add the status for LGG in relation to GBM
# For exmaple: status.gbm.lgg Hypomethyated means that the
# mean DNA methylation of probes for lgg are hypomethylated
# compared to GBM ones.
ra = rowAnnotation(df = values(sig.met)[status.col],
                   col = list("status.TCGA.GBM.TCGA.LGG" = 
                                c("Hypomethylated" = "orange",
                                  "Hypermethylated" = "darkgreen")),
                   width = unit(1, "cm"))

heatmap  <- Heatmap(assay(sig.met),
                    name = "DNA methylation",
                    col = matlab::jet.colors(200),
                    show_row_names = FALSE,
                    cluster_rows = TRUE,
                    cluster_columns = FALSE,
                    show_column_names = FALSE,
                    bottom_annotation = ta,
                    column_title = "DNA Methylation") 
# Save to pdf
png("heatmap.png",width = 600, height = 400)
draw(heatmap, annotation_legend_side =  "bottom")
dev.off()
```


![](heatmap.png)


### 模式分析
基序查找是为了找出隐藏在大量非功能性基因间序列的微小序列信号。这些小的核苷
酸序列（6-15 bp）有可能会有生物意义因为它们可以作为基因表达调控因子。这些序
列被称作调控模体。Bioconductor平台的[rGADEM](http://bioconductor.org/packag
es/rGADEM/)[@droit2015rgadem; @li2009gadem]提供了一种高效的*de 
novo*模体发现算法用于计算大规模的基因序列数据。




用户或许可能想要在确定出来的差异甲基化区域找寻一些唯一的信号，以识别可能与
这些受DNA甲基化累积或缺失影响的元素结合的候选转录因子。在本分析中，我们将使
用探针前后100 bp的区域进行分析（6-8行）。随后我们将会得到一个包含关于模式分
析所有信息对象（例如，序列的一致性，PWM，染色体，p值等）。





Bioconductor平台的[motifStack](http://bioconductor.org/packages/motifStack/
)[@ou2013motifstack]可以生成拥有不同相似分数的多个模件图形。


```{r results='asis', echo=TRUE, message=FALSE,warning=FALSE}
library(rGADEM)
library(BSgenome.Hsapiens.UCSC.hg19)
library(motifStack)

probes <- rowRanges(met)[values(met)[,status.col] %in% c("Hypermethylated" ,"Hypomethylated") ,]
# Get hypo/hyper methylated probes and make a 200bp window 
# surrounding each probe.
sequence <- RangedData(space = as.character(seqnames(probes)),
                       IRanges(start = start(ranges(probes)) - 100,
                               end = start(ranges(probes)) + 100), strand = "*")
#look for motifs
gadem <- GADEM(sequence, verbose = FALSE, genome = Hsapiens)

# How many motifs were found?
nMotifs(gadem)

# get the number of occurrences
nOccurrences(gadem)

# view all sequences consensus
consensus(gadem)

# Print motif
pwm <- getPWM(gadem)
pfm  <- new("pfm",mat=pwm[[1]],name="Novel Site 1")
plotMotifLogo(pfm)

# Number of instances of motif 1?
length(gadem@motifList[[1]]@alignList)

```

在得到[rGADEM](http://bioconductor.org/packages/rGADEM/)返回的结果后，用户
可以使用[MotIV](http://bioconductor.org/packages/MotIV/包[@mercier2014motiv
; @mahony2007dna; @mahony2007stamp; 
@mercier2011integrated]进行模件匹配分析（第4行）。


```{r results='asis', echo=TRUE,message=FALSE,warning=FALSE}
library(MotIV)
# motif matching analysis
analysis.jaspar <- motifMatch(pwm)
summary(analysis.jaspar)
plot(analysis.jaspar, ncol=2, top=5, rev=FALSE, main="", bysim=TRUE, cex=0.4)

#  visualize the quality of the results looking into the alignments
# E-value gives an estimation of the match.
alignment <- viewAlignments(analysis.jaspar)
print(alignment[[1]])
```


## 联合（表观遗传学和转录组学）分析

最近研究表明有深度的联合分析可以帮助研究者从高通量测序数据鉴别和提取更具有
生物学意义的信息[@phillips2008role; @shi2014integrative; 
@rhodes2005integrative]。在本节，我们将会介绍一个Bioconductor包：[ELMER](ht
tp://bioconductor.org/packages/ELMER/)，该包可以通过基因表达数据，DNA甲基化
数据以及模件分析得到增强子。除此之外，我们将会展示如何整合上几节来自于[ENCO
DE](http://www.encodeproject.org/) 
和[Roadmap](http://www.roadmapepigenomics.org/)重要表观遗传学数据。





### 整合DNA甲基化和基因表达数据 

在找到差异甲基化CpG位点后，或许会有人问附近的基因是否有表达量升高或者降低的
变化？位处基因启动子的DNA甲基化对于相应的基因有沉默作用。本文提出的星爆图是
将两个火山图的信息结合起来，对于DNA甲基化和基因表达研究具有一定的实用价值[@
noushmehr2010identification]。虽然我们希望基因表达和DNA甲基化数据都来自于相
同的样本，但是星爆图可以作为一种元分析工具以结合来自不同样本的数据[@siegmun
d2011statistical]。我们使用*TCGAvisualize\_starburst*函数来绘制星爆图。$log
_{10}$ (FDR-corrected 
p-value)用于DNA甲基化，被绘制于x轴，每个基因的基因表达量则位于y轴。水平位置
的黑色虚线用于标注基因表达数据的经FDR矫正后的p值$10^{-2}$，垂直的黑色虚线则
表明DNA甲基化的矫正后p值$10^{-2}$。 
参数met.p.cut和exp.p.cut用于控制黑色许虚线，参数diffmean.cut和logFC.cut用于
强调处于这些参数内的基因（下图中被圈起）。例如，我们设置了更高的p.cuts以得
到具有更高意义基因/探针对。但是接下来的一部分我们将会使用exp.p.cut = 
0.01和logFC.cut = 1。










```{R, eval=FALSE, include=TRUE}
#------------------- Starburst plot ------------------------------
starburst <- TCGAvisualize_starburst(met,    # DNA methylation with results
                                     dataDEGs,    # DEG results
                                     group1 = "Glioblastoma Multiforme", 
                                     group2 = "Brain Lower Grade Glioma", 
                                     filename = "starburst.png",
                                     genome = "hg19",
                                     met.platform = "450K",
                                     met.p.cut = 0.05,
                                     exp.p.cut = 10^-2,
                                     diffmean.cut = 0.15,
                                     logFC.cut = 1,
                                     width = 15,height = 10,
                                     names = TRUE)
```

```{r results='asis', echo=FALSE, message=FALSE, warning=FALSE}
#------------------- Starburst plot ------------------------------
starburst <- TCGAvisualize_starburst(met,    # DNA methylation with results
                                     dataDEGs,    # DEG results
                                     group1 = "TCGA-GBM", 
                                     group2 = "TCGA-LGG", 
                                     filename = "starburst.png",
                                     genome = "hg19",
                                     met.platform = "450K",
                                     met.p.cut = 0.05,
                                     exp.p.cut = 10^-2,
                                     diffmean.cut = 0.15,
                                     logFC.cut = 1,
                                     width = 15,height = 10,
                                     names = TRUE)
```

![](starburst.png)

由于时间原因，以及样本数目，基因和探针数目的减少使得前面的结果无法细致描述。大数据量的结果可以在[TCGAbiolinks vignette](https://bioconductor.org/packages/release/bioc/vignettes/TCGAbiolinks/inst/doc/tcgaBiolinks.html#tcgavisualize_starburst:_integration_of_gene_expression_and_dna_methylation_data)中找到。



### ChIP-seq分析

ChIP-seq主要用于确定转录因子和其他染色质相关蛋白是如何影响表型机制。确定蛋
白质于=与DNA的影响以及如何调控基因表达对于研究许多生物学过程及疾病有着重要
的意义。我们的目标是为进一步研究探索重叠数据集中共调控或转录因子的复合物。
每一个组蛋白标志的相关信息都被列在下表中。






```{r table4, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
|                  Histone marks                 |                                                   Role                                                  |
|:----------------------------------------------:|:-------------------------------------------------------------------------------------------------------:|
| Histone H3 lysine 4 trimethylation (H3K4me3)   | Promoter regions [@heintzman2007distinct,@bernstein2005genomic]                                      |
| Histone H3 lysine 4 monomethylation (H3K4me1)  | Enhancer regions [@heintzman2007distinct]                                                           |
| Histone H3 lysine 36 trimethylation (H3K36me3) | Transcribed regions                                                                                     |
| Histone H3 lysine 27 trimethylation (H3K27me3) | Polycomb repression [@bonasio2010molecular]                                                         |
| Histone H3 lysine 9 trimethylation (H3K9me3)   | Heterochromatin regions  [@peters2003partitioning]                                                  |
| Histone H3 acetylated at lysine 27 (H3K27ac)   | Increase activation of genomic elements [@heintzman2009histone,@rada2011unique,@creyghton2010histone] |
| Histone H3 lysine 9 acetylation  (H3K9ac)      | Transcriptional activation [@nishida2006histone]                                                    |
"
cat(tabl) 
```

此外，ChIP-seq数据存在于ROADMAP数据库，它们可以通过[AnnotationHub](http://b
ioconductor.org/packages/AnnotationHub/)包[@annotationHub]来获取，或者从[Ro
admap web portal](http://egg2.wustl.edu/roadmap/webportal/processed_data.ht
ml)获取。下面的表格为Annotationhub得到的roadmao文件的描述信息。

```{r table5, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "  
|                File                |                               Description                              |
|:----------------------------------:|:----------------------------------------------------------------------:|
| fc.signal.bigwig                   | Bigwig File containing  fold enrichment signal tracks                  |
| pval.signal.bigwig                 | Bigwig File containing -log10(p-value) signal tracks                   |
| hotspot.fdr0.01.broad.bed.gz       | Broad domains on enrichment for  DNase-seq for consolidated epigenomes |
| hotspot.broad.bed.gz               | Broad domains on enrichment for DNase-seq for consolidated epigenomes  |
| broadPeak.gz                       | Broad ChIP-seq peaks for consolidated  epigenomes                      |
| gappedPeak.gz                      | Gapped ChIP-seq peaks for consolidated   epigenomes                    |
| narrowPeak.gz                      | Narrow ChIP-seq peaks for consolidated epigenomes                      |
| hotspot.fdr0.01.peaks.bed.gz       | Narrow DNasePeaks for   consolidated epigenomes                        |
| hotspot.all.peaks.bed.gz           | Narrow DNasePeaks for  consolidated epigenomes                         |
| .macs2.narrowPeak.gz               | Narrow DNasePeaks for consolidated epigenomes                          |
| coreMarks_mnemonics.bed.gz        | 15 state chromatin segmentations                                       |
| mCRF_FractionalMethylation.bigwig | MeDIP/MRE(mCRF) fractional methylation calls                           |
| RRBS_FractionalMethylation.bigwig | RRBS fractional methylation calls                                      |
| WGBS_FractionalMethylation.bigwig | Whole genome bisulphite fractional methylation calls                   |
"
cat(tabl) 
```

得到ChIP-seq数据后，我们可以鉴别与星爆图中鉴定出的区域的重叠部分。narrowPea
k文件是在这一步中被选择的文件之一。处理Chip-seq数据的完整流程中，Bioconduct
or提供了许多优秀的教程参考。我们鼓励大家去回顾下面的文章[@ChIP-seqbioc]。第
一步为下载chip-seq数据。*query*函数将会接收annotationHub数据库（ah）的参数
并且用以搜索数据。*EpigenomeRoadmap*用于选择roadmap数据库。*consolidated*仅
用来选择联合基因组。*brain*用于选择大脑样本，E068大脑基因组中的一个(关键词
可以在下表中查找[summary 
table](https://docs.google.com/spreadsheets/d/1yikGx4MsO9Ei36b64yOy9Vb6oPC5
IBGlFbYEt-N6gOM/edit#gid=15))，narrowPeak用于选择文件类型。下载的数据是一个
从111个人类参照基因组整合分析后的处理数据[@kundaje2015integrative]。







```{r results='hide', eval=TRUE, echo=TRUE, message=FALSE,warning=FALSE}
library(ChIPseeker)
library(pbapply)
library(ggplot2)
```

```{r results='hide', eval=FALSE, echo=TRUE, message=FALSE,warning=FALSE}
#------------------ Working with ChipSeq data ---------------
# Step 1: download histone marks for a brain and non-brain samples.
#------------------------------------------------------------
# loading annotation hub database
library(AnnotationHub)
ah = AnnotationHub()

# Searching for brain consolidated epigenomes in the roadmap database
bpChipEpi_brain <- query(ah , c("EpigenomeRoadMap", "narrowPeak", "chip", "consolidated","brain","E068"))
# Get chip-seq data
histone.marks <- pblapply(names(bpChipEpi_brain), function(x) {ah[[x]]})
names(histone.marks) <- names(bpChipEpi_brain) 
# OBS: histone.marks is available in TCGAWorkflowData package
```


[Chipseeker](http://bioconductor.org/packages/ChIPseeker/)包[@yu2015chipsee
ker]实现了从Chip-seq数据中检索得到峰值周围基因的功能，并对于峰值周围区域的
基因进行注释。此外，它提供了多种可视化功能，以总结与TSS区域结合的峰的覆盖范
围、平均轮廓和热图、基因组注释、到TSS的距离以及峰或基因的重叠。




下载完组蛋白标价后，确定峰值与高甲基化或低甲基化区域结合的均值描述是很有用
处的，这可以帮助我们更好的理解我们所寻找到的区域。下面的代码将举例说明如何
绘制均值描述。



为了帮助用户更好的理解在DMR分析中找到的区域，我们使用AnnotationHub包从Roadm
ap数据库下载了脑组织的组蛋白标记。之后，Chipseeker用于可视化组蛋白修饰是如
何富集到高甲基化和低甲基化区域。将会展示富集的热图以及结合那些区域的峰值的
均值描述情况。





```{r results='hide', echo=TRUE, message=FALSE,warning=FALSE}
data(histoneMarks)
# Create a GR object based on the hypo/hypermethylated probes.
probes <- keepStandardChromosomes(rowRanges(met)[values(met)[,status.col] %in% c("Hypermethylated","Hypomethylated"),])
# Defining a window of 3kbp - 3kbp_probe_3kbp
ranges(probes) <- IRanges(start = c(start(ranges(probes)) - 3000), end = c(start(ranges(probes)) + 3000))

### Profile of ChIP peaks binding to TSS regions
# First of all, to calculate the profile of ChIP peaks binding to TSS regions, we should
# prepare the TSS regions, which are defined as the flanking sequence of the TSS sites.
# Then align the peaks that are mapping to these regions and generate the tagMatrix.
tagMatrixList <- pbapply::pblapply(histone.marks, function(x) {
  getTagMatrix(keepStandardChromosomes(x), windows = probes, weightCol = "score")
})
# change names retrieved with the following command: basename(bpChipEpi_brain$title)
names(tagMatrixList) <- c("H3K4me1","H3K4me3", "H3K9ac", "H3K9me3", "H3K27ac",  "H3K27me3", "H3K36me3")
```

使用`tagHeatmap`绘制富集热图

```{R, eval=FALSE, include=TRUE}
tagHeatmap(tagMatrixList, xlim=c(-3000, 3000),color = NULL)
```

```{r results='asis', echo=FALSE, fig.width = 7, message=FALSE,warning=FALSE}
tagHeatmap(tagMatrixList, xlim=c(-3000, 3000),color = NULL)
```

使用`plotAvgProf`绘制结合在那些区域的峰值的均值描述:
```{R, eval=FALSE, include=TRUE}
p <- plotAvgProf(tagMatrixList, xlim = c(-3000,3000), xlab = "Genomic Region (5'->3', centered on CpG)")
# We are centreing in the CpG instead of the TSS. So we'll change the labels manually
p <- p + scale_x_continuous(breaks=c(-3000,-1500,0,1500,3000),labels=c(-3000,-1500,"CpG",1500,3000))
library(ggthemes)
p + theme_few() + scale_colour_few(name="Histone marks") +  guides(colour = guide_legend(override.aes = list(size=4)))
```

```{r results='asis', echo=FALSE, message=FALSE,warning=FALSE}
p <- plotAvgProf(tagMatrixList, xlim = c(-3000,3000), xlab = "Genomic Region (5'->3', centered on CpG)")
# We are centreing in the CpG instead of the TSS. So we'll change the labels manually
if (requireNamespace("ggplot2", quietly = TRUE)) 
  p <- p + ggplot2::scale_x_continuous(breaks=c(-3000,-1500,0,1500,3000),
                                       labels=c(-3000,-1500,"CpG",1500,3000))

if (requireNamespace("ggthemes", quietly = TRUE)) 
  p + ggthemes::theme_few() + 
  ggthemes::scale_colour_few(name="Histone marks") + 
  ggplot2::guides(colour = guide_legend(override.aes = list(size=4)))
```

去甲基化与超甲基化区域富集在H3K4me3，H3K9ac，H3K27ac和H3K4me1区域，这表明它
们是增强子区域，启动子区域和基因原件激活的区域。然而，由于H3K36me3和H3K27me
3热图在0点附近没有富集，平均剖面也没有在0点处出现峰值，这些区域既不与转录区
域相关，也没有Polycomb抑制作用。




## 通过甲基化/表达关系关联的增强子

近年来，许多研究表明增强子在细胞特异性表型调控中起着重要作用，导致与疾病相
关的转录组发生改变[@giorgio2015large; @groschel2014single; @sur2012mice; 
@yao2015demystifying]。为了研究那些可能处于特定基因上下游较远地方的增强子调
控，Bioconductor提供了[Enhancer Linking by Methylation/Expression 
Relationship(ELMER)](http://bioconductor.org/packages/ELMER/) 
包。该包设计用以结合来自人体组织的DNA甲基化数据和基因表达数据从而推测多层次
基因网络。它使用DNA甲基化来鉴别增强子同时关联它们的状态与附近基因的表达情况
，从而得到一个或多个转录目标。增强子的转录因子（TF）结合位点分析关联了全部
转录因子的表达分析以此来推测上游调控情况。这个包可以轻松的应用到TCGA的公共
数据以及自定义的DNA甲基化和基因表达数据[@yao2015inferring,@ChedraouiSilva14
8726]。







[ELMER](http://bioconductor.org/packages/ELMER/)分析主要有五个步骤：


1. 鉴定位于HM450K或EPIC的远端探针。

2. 肿瘤vs正常样本中关于显著差异DNA甲基化区域的远端探针的鉴定。

3. 差异甲基化远端探针的靶基因鉴定。

4. 在一组探针中，在显著探针-基因对中识别富集的基序。

5. 鉴定每个富集基序的主调控转录因子(TF)。

本节将会展示如何使用ELMER来分析TCGA数据，我们仍使用LGG和GBM数据举例。

### ELMER包的数据处理{#preparing-the-data-for-elmer-package .unnumbered}



下面展示了如何使用[TCGAbiolinks](http://bioconductor.org/packages/TCGAbioli
nks/)[@TCGAbiolinks]来搜索，下载，准备数据以用于[ELMER](http://bioconductor
.org/packages/ELMER/)包。由于时间及内存限制，我们只使用10个GBM和10个LGG的病
人数据，包含基因表达与DNA甲基化。这些样本和之前的步骤所用的一致。





为了进行ELMER分析，我们需要在一个**MultiAssayExperiment**中填充一个DNA甲基化矩阵或来自HM450K或EPIC平台的**SummarizedExperiment**对象;同一样本的基因表达矩阵或摘要实验对象;将DNA甲基化样本映射到基因表达样本的矩阵;以及带有示例元数据的矩阵（例如，临床信息，分子亚型等）。如果使用TCGA数据，后两个矩阵将会自动生成。
如果不使用TCGA数据，样本元信息的矩阵需要自己提供，同时其中拥有一列表明病人信息以及一列表明病人分组。如果甲基化矩阵和基因表达矩阵中样本没有排序且没有相同的名字，那应该应该向createMAE函数提供每个患者标识符的矩阵映射，其中包括其DNA甲基化样本和基因表达样本。
基于我们选择的参考基因组，DNA甲基化探针的元数据，例如基因坐标将从http://zwd
zwd.github.io/InfiniumAnnotation [@zhou2016comprehensive]添加；基因表达的元数据和注释将通过[biomaRt](http://bioconductor.org/packages/biomaRt/)[@durinck2009mapping]从Ensembl数据库中添加。

```{R, eval=FALSE, include=TRUE}
#----------- 8.3 Identification of Regulatory Enhancers   -------
library(TCGAbiolinks)
# Samples: primary solid tumor w/ DNA methylation and gene expression
lgg.samples <- matchedMetExp("TCGA-LGG", n = 10)
gbm.samples <- matchedMetExp("TCGA-GBM", n = 10)
samples <- c(lgg.samples,gbm.samples)

#-----------------------------------
# 1 - Methylation
# ----------------------------------
query.met <- GDCquery(project = c("TCGA-LGG","TCGA-GBM"),
                      data.category = "DNA methylation",
                      platform = "Illumina Human Methylation 450",
                      legacy = TRUE, 
                      barcode = samples)
GDCdownload(query.met)
met <- GDCprepare(query.met, save = FALSE)
met <- subset(met,subset = as.character(GenomicRanges::seqnames(met)) %in% c("chr9"))

#-----------------------------------
# 2 - Expression
# ----------------------------------
query.exp <- GDCquery(project = c("TCGA-LGG","TCGA-GBM"),
                      data.category = "Gene expression",
                      data.type = "Gene expression quantification",
                      platform = "Illumina HiSeq", 
                      file.type  = "results", 
                      legacy = TRUE, 
                      barcode =  samples)
GDCdownload(query.exp)
exp <- GDCprepare(query.exp, save = FALSE)
save(exp, met, gbm.samples, lgg.samples, file = "elmer.example.rda", compress = "xz")
```

HumanMethylationEPIC (EPIC) array和Infinium HumanMethylation450 (HM450) 
array的探针如果在探针3'末端存在内部SNP；非特异性比对到重亚硫酸盐转换基因组；或者脱靶均会被移除[@doi:10.1093/nar/gkw967]。探针元文件信息在[ELMER.data](https://github.com/tiagochst/ELMER.data)包中，源文件来自于http://zwdzwd.github.io/InfiniumAnnotation [@doi:10.1093/nar/gkw967]。
为了限制ELMER对远端元素的分析，在转录起始位点(TSSs)周围位于$\pm2 kb$区域的探针被移除。使用*get.feature.probe*函数检索远端元件。


```{r, message=FALSE,warning=FALSE}
library(ELMER)
library(MultiAssayExperiment)
library(GenomicRanges)
distal.probes <- get.feature.probe(genome = "hg19", 
                                   met.platform = "450K")

# Recover the data created in the last step
data(elmerExample)
rownames(exp) <- values(exp)$ensembl_gene_id
mae <- createMAE(exp = exp, 
                 met = met,
                 save = TRUE,
                 linearize.exp = TRUE,
                 save.filename = "mae.rda",
                 filter.probes = distal.probes,
                 met.platform = "450K",
                 genome = "hg19",
                 TCGA = TRUE)
mae
```

## ELMER分析

把数据处理为一个MAE对象后，我们将运行[ELMER](http://bioconductor.org/packag
es/ELMER/)的五个步骤来探索去势，即在GBM与LGG比较中，寻找去甲基化的远端增强
子探针。远端增强子探针搜索过程的描述详见[ELMER.data](https://bioconductor.o
rg/packages/release/data/experiment/vignettes/ELMER.data/inst/doc/vignettes
.pdf)。由于样本数量太小了，我们需要放宽阈值。


```{r, warning=FALSE, results="hide"} 
cores <- 1 # you can use more cores if you want
group.col <- "project_id"
group1 <- "TCGA-GBM"
group2 <- "TCGA-LGG"

# Available directions are hypo and hyper, we will use only hypo
# due to speed constraint
direction <- "hypo"
dir.out <- paste0("elmer/",direction)
dir.create(dir.out, showWarnings = FALSE, recursive = TRUE)
```

### 有监督和无监督分析模型


ELMER被设计用于鉴定在已给数据中两个样本分组之间的差别。但是，开始我们的分析之前，理解ELMER 2.0中两个分析模型将对我们更有帮助（有监督模型和无监督模型），这将会影响到每一次比较中样本的选择。

在最开始的版本中[@yao2015inferring]，第一步-肿瘤vs非肿瘤中差异甲基化CpG探针的鉴定是很难通过代码完成的，而下一步是关于在肿瘤任意子集中的无监督识别变化。在ELMER 2.0中，我们推广了这一策略，使它适用于任何配对的数据集，包括任何疾病类型的疾病与健康组织。
 
在无监督模型中，例如ELMER 1.0版本，我们假设至少分组中有一个是异质性的（例如，乳腺浸润性癌原发实体瘤标本可分为基底型、腔内型、Her2分子亚型），由于这个原因，我们使用了基于DNA甲基化水平的两个最极端的五分位数的比较样本，生成了$M$(甲基化)和$U$(非甲基化)两组。 在监督模式下，假设我们的组是齐次的，因此$U$和$M$组严格由样本组标签定义，每个组中的所有样本都被使用[@ChedraouiSilva148726]。

接下来我们将使用监督模式进行ELMER分析，该模式将使用GBM中的所有样本，并将所有分析中的所有LGG样本进行比较。

### 差异甲基化CpGs (DMCs)的鉴定

对于每一个远端探针，每组（组1和组2）中的样本都将按照N=DNA甲基化beta值进行排序，使用非配对单侧t检验，将每组中较低的五分位数(甲基化水平最低的20%样本)的样本用于鉴别第一组和第二组的探针是否低甲基化。20%是*diff.meth*函数的一个参数被称作*minSubgroupFrac*。 对于未分组的肿瘤情况，这个值在[@yao2015inferring]被设定为20%，因为因为我们通常希望能够在肿瘤样本中检测到特定的分子亚型；这些亚型通常只占样本的一小部分，为了提高统计能力，选择了20%作为下限（足够高的样本数量可以产生t检验p值，可以克服多个假设纠正，但足够低的样本数量可以捕获发生在20%或更多情况下的单个分子亚型的变化。）这个数字在使用 *diff.meth*函数时可以被随意设定，应根据个别研究的样本大小进行调整。

由于我们处理的样本数量较少，而且我们正在比较两种癌症类型，因此将*minSubgroupFrac*参数设置为100%，以便在此分析中使用所有样本。 


```{r, warning=FALSE, results="hide"} 
#--------------------------------------
# STEP 3: Analysis                     |
#--------------------------------------
# Step 3.1: Get diff methylated probes |
#--------------------------------------
message("Get diff methylated probes")
Sig.probes <- get.diff.meth(data = mae, 
                            group.col = group.col,
                            group1 = group1,
                            group2 =  group2,
                            minSubgroupFrac = 1.0, # Use all samples
                            sig.dif = 0.2, # defualt is 0.3
                            diff.dir = direction, # Search for hypomethylated probes in group 1
                            cores = cores, 
                            dir.out = dir.out, 
                            pvalue = 0.1)
```
```{r, warning=FALSE} 
datatable(Sig.probes[1:10,], 
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)
```

### 差异甲基化远端探针的靶基因鉴定

对于每个差异甲基化远端探针(DMC)，分别检测最接近的10个上游基因和最接近的10个
下游基因，检测探针的甲基化与基因表达的负相关关系（数字10可以使用*numFlankin
gGenes*参数进行更改）。为了选择这些基因，探针-基因距离被定义为探针到转录起
始位点的距离，由通过R/Bioconductor的[biomaRt](http://bioconductor.org/packa
ges/biomaRt/) [@durinck2009mapping,@durinck2005biomart]访问的ENSEMBL基因[@y
ates2015ensembl]注释指定。通过为每个探针选择一定数量的基因进行检测，我们的目标是避免在基因丰富的区域对探针产生系统性的假阳性。鉴于哺乳动物基因组的基因密度高度不均匀，这一点尤为重要。因此，我们对每个探针进行了20个统计检验，如下所示。

对于每一对probe-gene来说，样品(所有两组样本)分为两组：M组，由上层甲基化的五
分位数(最高的20%的样品甲基化增强子探针)，和U组，由甲基化最低的五分位数(20%
样本最低的甲基化)。20%是*get.pair*函数中一个可调整的参数，为*minSubgroupFra
c*。

就像*diff.meth*函数中它的使用方式一样，默认值20%是一个平衡点，这使得分子亚
型中鉴别出来的变化属于少数情况（如20%），同时也产生了足够的统计力量来做出强有力的预测。对于较大的样本量或其他实验设计，这个值可以设置得更低。

对于每个候选探针基因对，采用Mann-WhitneyU检验检验原假设，即M组总基因表达量
大于或等于U组。使用这种非参数检验是为了最小化表达式异常值的影响，表达式异常
值可以发生在非常大的动态范围内。 
使用这种非参数检验是为了最小化表达式异常值的影响，表达式异常值可以发生在非
常大的动态范围内。对于每个被测试的探针基因对，原始的p值$P_r$使用以下排列方
法对多个假设进行校正。配对中的基因为一个常数，*x*随机甲基化探针进行相同的单
侧U检验生成一组*x*排列的p值$P_p$。我们只从那些“远端”(距离注释转录起始点超过
$2kb$)的随机探针中选择x个，以便从与被测试探针相同的集合中绘制这些空模型探针
[@sham2014statistical]。
经验p值$P_e$值使用以下公式计算： 
（引入了伪计数为1）：




\begin{equation}
P_e = \frac{num(P_p \leq P_r)+ 1}{x+1}
\end{equation}

注意，在*Supervised*模式中，不需要额外的过滤来确保M和U组被样本分组标签隔离。根据定义，这两个样本组是分离的，因为选择这两个探针是为了在两组之间进行具有相同方向性的差异甲基化。
 
在我们的例子中，我们将评估的最接近的基因数量减少到5个(最接近的两个上游基因和最接近的两个下游基因)。 将*mode*设置为“supervised”，将group 1 (GBM samples)设为$U$组，group 2 (LGG samples)设为$M$组。

此外，为了使示例更快，置换的数量减少到5 (*permu.size* = 5)，原始p值截断放宽到0.1，经验p值放宽到0.5，但在实际分析中建议使用默认值。

```{r, warning=FALSE, results="hide"} 
#-------------------------------------------------------------
# Step 3.2: Identify significant probe-gene pairs            |
#-------------------------------------------------------------
# Collect nearby 20 genes for Sig.probes
message("Get nearby genes")
nearGenes <- GetNearGenes(data = mae,
                          numFlankingGenes = 4, # default is 20 genes
                          probes = Sig.probes$probe)

message("Get anti correlated probes-genes")
pair <- get.pair(data = mae,
                 group.col = group.col,
                 group1 = group1,
                 group2 =  group2,
                 nearGenes = nearGenes,
                 mode = "supervised",
                 minSubgroupFrac = 1, # % of samples to use in to create groups U/M
                 permu.dir = paste0(dir.out,"/permu"),
                 permu.size = 5, # Please set to 100000 to get significant results
                 raw.pvalue = 0.1,   # defualt is 0.001
                 Pe = 0.5, # Please set to 0.001 to get significant results
                 filter.probes = TRUE, # See preAssociationProbeFiltering function
                 filter.percentage = 0.05,
                 filter.portion = 0.3,
                 dir.out = dir.out,
                 diff.dir = direction,
                 cores = cores,
                 label = direction)
```
```{r, warning=FALSE} 
head(nearGenes)
datatable(pair[1:10,], 
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)
```

### 基序富集分析

 为了识别富集的基序和潜在的上游调控TFs，我们使用HOCOMOCO v11 [@kulakovskiy2016hocomoco] TF结合模型作为HOMER [@heinz2010simple]的输入，从EPIC和HM450阵列中找到每个探针周围$\pm 250bp$区域的基序发生情况。转录因子（TF）结合模型可以从 Transcription factor (TF) http://hocomoco.autosome.ru/downloads 获取（使用与p值$>1^{-4}$对应的阈值级别的特定于HOMER格式）。



以Fisher’s exact test和Benjamini-Hochberg多重假设检验校正为校正背景，对所有远端探针进行motif富集分析。

如果Odds Ratio的95%置信区间大于$1.1$（由*lower。OR*确定，$1.1$是默认值），
且基序出现至少10次（由*min.incidence*确定，$10$为默认值），那么该基因集被认
为对于特定的基序为显著富集。



```{r, warning=FALSE, results="hide"} 
#-------------------------------------------------------------
# Step 3.3: Motif enrichment analysis on the selected probes |
#-------------------------------------------------------------
enriched.motif <- get.enriched.motif(data = mae,
                                     probes = pair$Probe, 
                                     dir.out = dir.out, 
                                     label = direction,
                                     pvalue = 1, # default is FDR < 0.05
                                     min.incidence = 10,
                                     lower.OR = 1.1)
# One of the output from the  previous function is a file with the motif, OR and Number of probes
# It will be used for plotting purposes
motif.enrichment <- read.csv(paste0(dir.out,"/getMotif.",direction, ".motif.enrichment.csv"))
```
```{r, warning=FALSE} 
head(enriched.motif[names(enriched.motif)[1]]) ## probes in the given set that have the first motif.
datatable(motif.enrichment, 
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          filter = 'top',
          rownames = FALSE)
```

### 主调节转录因子的鉴定



当一组增强子在一个特定的样本子集中协同改变时，这通常是基因调控网络中上游*主调控*转录因子改变的结果。 *ELMER*试图鉴定从上一步分析中得到的富集的转录因子结合基序一一对应的转录因子。
对于每一个富集的基序，*ELMER*采用所有带有基序发生（在$\pm 250bp$区域）的远端探针的DNA甲基化均值（显著的探针-基因对），并将其与每一个被注释为人类转录因子的基因表达量进行比较。


在无监督模式下，对每个基序-转录因子对进行统计检验，结果如下：所有的样本被分
为两组:$M$组和$U$组，前者由所有邻近motif探针中平均甲基化最高的20%的样本组成
，后者由甲基化最低的20%的样本组成。此步骤由get。TFs函数执行，该函数以*minSu
bgroupFrac*作为输入参数，同样默认值为20%。对于每个候选基序-转录因子对，Mann
-Whitney U检验用于检验null 
hypothesis，即$M$组的总基因表达量大于或等于$U$组的总基因表达量。使用这种非
参数检验是为了最小化表达式异常值的影响，表达式异常值可以发生在非常大的动态
范围内。对于每个测试的基序，这将为每个人类的转录因子生成一个原始的p值（$P_r
$）。


所有的TFs都是根据它们的$-log_{10}(Pr)$值进行排名的，而那些位于该排名前5%的
转录因子被认为是上游监管机构的候选。已知的能够识别特定结合基序的最佳上游转
录因子被自动提取为假定的调节转录因子，并创建秩序图来直观地检查这些关系，如
下面的示例所示。由于相同的基序可以被同一结合域家族的许多转录因子识别，因此
我们利用TFClass数据库中的分类方法，在家族和亚家族的分类层次上定义了这些关系 [@wingender2013tfclass]。

监督模式采用与上述方法相同的方法来识别假定的目标基因。$U$和$M$组是样本的标签组之一，*minSubgroupFrac*参数被设置为100%，以便在统计测试中使用来自这两组的所有样本。



```{r, warning=FALSE, results="hide"} 
#-------------------------------------------------------------
# Step 3.4: Identifying regulatory TFs                        |
#-------------------------------------------------------------
TF <- get.TFs(data = mae, 
              group.col = group.col,
              group1 = group1,
              group2 =  group2,
              mode = "supervised",
              enriched.motif = enriched.motif,
              dir.out = dir.out, 
              cores = cores,
              save.plots = FALSE,
              diff.dir = direction,
              label = direction)
    
# One of the output from the previous function is a file with the raking of TF,
# for each motif. It will be used for plotting purposes
TF.meth.cor <- get(load(paste0(dir.out,"/getTF.",direction,".TFs.with.motif.pvalue.rda")))
```


这步所得到的结果为一个包含下列内容的数据框:

- *motif*:  富集的基序名称。
- *top_5percent_TFs*: 前5%的转录因子
- *potential.TFs.family*: 来自于"top_5percent_TFs"的转录因子同和基序的转录因子来自于同一家族  
- *top.potential.TFs.family* 是属于基序转录因子家族中排名最高的转录因子（与第一列相同）。 
- *potential.TFs.subfamily* 和*top.potential.TFs.subfamily* 与*potential.TFs.family*和*top.potential.TFs.family* 相同，但被认为是亚科分类 (你可以从以下网站找到分类http://hocomoco11.autosome.ru/human/mono?full=true). 


```{r, warning=FALSE} 
datatable(TF, 
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = FALSE)
datatable(TF.meth.cor[1:10,1:6], 
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)
```

### ELMER可视化函数

由ELMER得到的对可以通过`heatmapPairs`进行可视化。第一个热图显示了DNA甲基化
水平，第二个热图显示了目标基因的基因表达水平。最后一张热图显示了探针和基因
转录起始位点（TSS）之间的距离。

```{r, echo=TRUE, message=FALSE,eval = FALSE, warnings=FALSE, results='asis',fig.height=6, fig.width=10}
heatmapPairs(data = mae, 
             group.col = group.col,
             group1 = group1, 
             group2 = group2, 
             annotation.col = c("gender"),
             pairs = pair,
             filename =  NULL)
```


当ELMER确定远端增强子探针的富集基序时，它将绘制发现的每个基序的优势比(x轴)。



下表为去甲基化方向（GBM较于LGG为去甲基化），OR >= 1.1。 




```{r, echo=TRUE, message=FALSE, warnings=FALSE, results='asis',fig.height=4,fig.width=15}
motif.enrichment.plot(motif.enrichment = motif.enrichment, 
                      save = FALSE,
                      significant = list(lowerOR = 1.1)) # Filter motifs in the plot lowerOR > 1.3
```

在找到富集基序后，[ELMER](http://bioconductor.org/packages/ELMER/)找到了调
控转录因子（TFs），这些TFs的表达量与在基序上DNA甲基化情况相关。[ELMER](http
://bioconductor.org/packages/ELMER/)会自动为每个富集基序创建一个转录因子排
名图。 这个图显示了基于转录因子表达与基序DNA甲基化之间的关联评分$(-log(p-va
lue))$的排序图。 这个图表示了所有T转录因子的p值的秩，突出显示了前3个以及根
据TFClass数据库划分为同一家族和子家族的T转录因子。虚线代表了前5%的转录因子
。 




```{R, eval=FALSE, include=TRUE}
grid:TF.rank.plot(motif.pvalue=TF.meth.cor, motif=TF$motif[1], save=FALSE)
```	
```{r results='asis', echo=FALSE, message=FALSE,warning=FALSE,  fig.align='center',fig.height=8,fig.width=8}
gg <- TF.rank.plot(motif.pvalue=TF.meth.cor, motif=TF$motif[1], save=FALSE)
grid::grid.draw(gg[[1]])
```	

此外，对于每个主基序，我们可以看看三个最相关的转录因子。
例如，此外，对于每个基序，我们可以看看三个最相关的转录因子。例如，下图显示
了第一个基序与一些与之相关的转录因子的表达相对应的位点的平均DNA甲基化水平。
我们可以看到，随着基序的绘制，GBM样品的平均甲基化水平较低，而转录因子的平均
表达水平较高。

```{r results='asis', echo=TRUE, message=FALSE, warning=FALSE}
png("TF.png",width = 800, height = 400)
scatter.plot(mae, 
             category = group.col, 
             save = FALSE, 
             lm_line = TRUE,
             byTF=list(TF=unlist(stringr::str_split(TF[1,"top_5percent_TFs"],";"))[1:4], 
                       probe=enriched.motif[[TF$motif[1]]]))
dev.off()
```
![](TF.png)



# 结论

本工作流程概述了如何使用特定的Bioconductor包来分析癌症基因组学和TCGA导出的
表观基因组学数据。此外，我们还强调了利用ENCODE和Roadmap数据来了解基因调控中
功能角色所定义的非编码元素的生物学的重要性。我们介绍了[TCGAbiolinks](http:/
/bioconductor.org/packages/TCGAbiolinks/)和[RTCGAToolbox](http://bioconduct
or.org/packages/RTCGAToolbox/)以展示如何获取TCGA的特定数据，接下来是一些关
于基因组分析的关键步骤，我们使用[GAIA](http://bioconductor.org/packages/gai
a/) 和[maftools](http://bioconductor.org/packages/maftools/)完成，对于转录
组分析，我们通过[TCGAbiolinks](http://bioconductor.org/packages/TCGAbiolink
s/) 和[pathview](http://bioconductor.org/packages/pathview/)完成，对于DNA甲
基化分析，我们使用[TCGAbiolinks](http://bioconductor.org/packages/TCGAbioli
nks/)完成。[MINET](http://bioconductor.org/packages/minet/) 
也介绍了基因调控网络的推论。最后，我们介绍了[AnnotationHub](http://biocondu
ctor.org/packages/AnnotationHub/)，[ChIPSeeker](http://bioconductor.org/pac
kages/ChIPseeker/)，[ComplexHeatmap](http://bioconductor.org/packages/Compl
exHeatmap/)和[ELMER](http://bioconductor.org/packages/ELMER/)来说明如何获取
编码/路线图数据，并将这些数据与分析TCGA数据得到的结果集成起来，从而识别和表
征与癌症相关的候选调控增强子。










# Session Information

```{r}
pander::pander(sessionInfo(), compact = FALSE)
```

# Author contributions {#author-contributions .unnumbered}

HN conceived the study. HN, MC and GB provided direction on the design
of the Transcriptomics, Genomics, master regulatory networks and DNA
methylation workflows. TCS developed and tested sections "Experimental
data", "DNA methylation analysis", "Motif analysis" and "Integrative
analysis". AC developed and tested section "Transcriptomic analysis". CO
developed and tested the section "Inference of gene regulatory
networks". FDA developed and tested section "Genomic analysis". TCS, AC,
CO, and FDA prepared the first draft of the manuscript. All authors were
involved in the revision of the draft manuscript and have agreed to the
final content. Also, AC, TS, CO, MC, GB, and HN are authors of the
TCGAbiolinks package and MC is the author of the GAIA package.

# Competing interests {#competing-interests .unnumbered}

No competing interests were disclosed.

# Grant information {#grant-information .unnumbered}

The project was supported by the São Paulo Research Foundation
([FAPESP](http://www.fapesp.br/)) (2015/02844-7 and 2016/01389-7 to
T.C.S. & H.N. and 2015/07925-5 to H.N.), the [BridgeIRIS
project](http://mlg.ulb.ac.be/BridgeIRIS), funded by INNOVIRIS, Region
de Bruxelles Capitale, Brussels, Belgium, and by GENomic profiling of
Gastrointestinal Inflammatory-Sensitive CANcers
([GENGISCAN](http://mlg.ulb.ac.be/GENGISCAN)), Belgian FNRS PDR
(T100914F to G.B.). Funding for open access charge: São Paulo Research
Foundation (FAPESP) (2015/07925-5).

# Acknowledgements {#acknowledgements .unnumbered}

We are grateful to all the authors of the packages used in this article.
Also, we would like to thank The GDC Support Team for the provided help,
which was necessary in order to update the TCGAbiolinks package to use
GDC API.

# References
